<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nueva Venta - POS Cosmetiquer铆a</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <style>
        /* [Se mantienen todos los estilos CSS para el dise帽o] */
        :root {
            --color-primario: #c71585; 
            --color-primario-hover: #a6126f;
            background: linear-gradient(160deg, #f9e8f1 0%, #ffffff 100%);
            --color-card: #FFFFFF;
            --color-card-header: #37474F; 
            --color-card-header-texto: #FFFFFF;
            --color-texto: #333;
            --color-borde: #E0E0E0;
            --color-rojo: #D32F2F;
            --color-rojo-hover: #C62828;
        }

        html { height: 100%; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", sans-serif;
            background-color: var(--color-fondo) !important;
            color: var(--color-texto);
            display: flex;
            flex-direction: column;
            min-height: 100%; 
        }

        .container-venta {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            max-width: 1400px;
            margin: 20px auto; 
            padding: 0 20px; 
            flex: 1;
        }

        .columna-izquierda {
            flex: 1.5;
            display: flex;
            flex-direction: column;
            gap: 20px;
            min-width: 300px;
        }

        .columna-derecha {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
            min-width: 300px;
        }

        .card {
            background-color: var(--color-card);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            border: none;
        }

        .card-header {
            background-color: var(--color-card-header);
            color: var(--color-card-header-texto);
            padding: 15px 20px;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .card-body {
            padding: 20px;
        }

        .form-grupo {
            margin-bottom: 15px;
        }

        .form-grupo label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }

        .form-control, .form-select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--color-borde);
            border-radius: 8px;
            box-sizing: border-box; 
            font-size: 1rem;
            background-color: #FFFFFF;
            color: #333;
        }

        .form-control:focus, .form-select:focus {
            outline: none;
            border-color: var(--color-primario);
            box-shadow: 0 0 0 2px rgba(199, 21, 133, 0.2);
        }

        .btn-primario {
            background-color: var(--color-primario);
            color: white;
            width: 100%;
            padding: 12px 20px;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            text-decoration: none;
            transition: background-color 0.2s ease;
        }

        .btn-primario:hover {
            background-color: var(--color-primario-hover);
        }

        .btn-rojo {
            background-color: var(--color-rojo);
            color: white;
            padding: 5px 10px;
            font-size: 0.8rem;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        .btn-rojo:hover {
            background-color: var(--color-rojo-hover);
        }

        .tabla {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .tabla th, .tabla td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--color-borde);
        }

        .tabla th {
            background-color: #F9F9F9;
            font-weight: 600;
            color: #444;
        }

        .tabla td {
            vertical-align: middle;
        }

        .resumen-total {
            text-align: right;
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--color-primario);
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px dashed var(--color-primario);
        }

        .pagos-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .detalles-pago {
            margin-top: 15px;
            border-top: 1px dashed #ccc;
            padding-top: 15px;
            background-color: #fafafa;
            padding: 10px;
            border-radius: 8px;
        }
        .detalles-pago strong {
            color: var(--color-primario);
            font-size: 0.9rem;
        }

        .pagos-grid .form-grupo:last-child:nth-child(odd) {
            grid-column: 1 / -1; 
        }

        footer {
            background-color: var(--color-secundario, #c71585); 
            color: #fff; 
            padding: 10px 0; 
            text-align: center;
            margin-top: auto; 
            font-size: 0.9rem;
            width: 100%; 
        }
        footer a {
            font-weight: 600;
            color: #fff; 
            text-decoration: none;
        }
        footer a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>

{% if current_user.is_authenticated %}
<nav class="navbar navbar-expand-lg navbar-dark navbar-custom">
    <div class="container-fluid">
        <a class="navbar-brand d-flex align-items-center" href="{{ url_for('dashboard') or url_for('clientes') }}">
            <img src="{{ url_for('static', filename='img/LOGO.png') }}" alt="Logo" style="height:40px; margin-right:8px;">
            LA COSMETIQUERA DE GABI
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
            aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav mx-auto mb-2 mb-lg-0">
                <li class="nav-item"><a class="nav-link" href="{{ url_for('inventario') }}">Inventario</a></li>
                <li class="nav-item"><a class="nav-link" href="{{ url_for('clientes') }}">Clientes</a></li>
                <li class="nav-item"><a class="nav-link active" aria-current="page" href="{{ url_for('nueva_venta') }}">Ventas Diarias</a></li> 
                {% if current_user.rol.lower() == 'administrador' %}
                <li class="nav-item"><a class="nav-link" href="{{ url_for('reportes') }}">Cierre / Informes</a></li>
                <li class="nav-item"><a class="nav-link" href="{{ url_for('usuarios') }}">Gesti贸n de Usuarios</a></li>
                {% endif %}
            </ul>
            <span class="navbar-text me-3 text-white">
                Hola, {{ current_user.username }}
                <span class="badge bg-white text-dark">{{ current_user.rol }}</span>
            </span>
            <a class="btn btn-primary" href="{{ url_for('logout') }}">Cerrar Sesi贸n</a>
        </div>
    </div>
</nav>
{% endif %}

<script id="product-data" type="application/json">
[
  {% for p in productos %}
  {
    "id": {{ p.id }},
    "nombre": {{ p.nombre | tojson }},
    "codigo": "{{ p.codigo }}",
    "precio": {{ p.valor_venta }},
    "stock": {{ p.cantidad }}
  }
  {% if not loop.last %},{% endif %}
  {% endfor %}
]
</script>

<div class="container-venta">
    <div class="columna-izquierda">

        <div class="card">
            <div class="card-header"><i class="bi bi-upc-scan"></i> ESCANEAR PRODUCTO (Lector o Manual)</div>
            <div class="card-body">
                <div class="form-grupo">
                    <input type="text" id="escaner_codigo" class="form-control" placeholder="Escanee el c贸digo aqu铆 y presione Enter...">
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header"><i class="bi bi-person-plus"></i> A帽adir Productos Manualmente</div>
            <div class="card-body">
                <div class="form-grupo">
                    <label for="manual_producto">Producto</label>
                    <select name="producto" id="manual_producto" class="form-select">
                        <option value="">-- Seleccionar Producto --</option>
                        {% for p in productos %}
                        <option value="{{ p.id }}">
                            {{ p.nombre }} - {{ p.descripcion }} | (${{ "%.0f"|format(p.valor_venta) }}) - Stock: {{ p.cantidad }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-grupo">
                    <label for="manual_cantidad">Cantidad</label>
                    <input type="number" id="manual_cantidad" class="form-control" value="1" min="1">
                </div>
                <button type="button" class="btn btn-primario" onclick="agregarManual()">
                    <i class="bi bi-plus-circle"></i> Agregar Manual
                </button>
            </div>
        </div>

        <div class="card">
            <div class="card-header"><i class="bi bi-person"></i> Selecci贸n de Cliente</div>
            <div class="card-body">
                <div class="form-grupo">
                    <select name="cliente_id" id="cliente_id" class="form-select" form="form_venta"> 
                        {% for cliente in clientes %}
                            <option value="{{ cliente.id }}" {% if cliente.id == 1 %}selected{% endif %}>{{ cliente.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>

    </div>

    <div class="columna-derecha">
        <form method="POST" id="form_venta" onsubmit="return validarYEnviar(event)" style="display: flex; flex-direction: column; gap: 20px;">
            
            <div class="card">
                <div class="card-header"><i class="bi bi-cart3"></i> Resumen de Carrito</div>
                <div class="card-body">
                    <table class="tabla">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Cant.</th>
                                <th>Subtotal</th>
                                <th>Acci贸n</th>
                            </tr>
                        </thead>
                        <tbody id="carrito-body"></tbody>
                    </table>
                    <div class="resumen-total">
                        TOTAL: $ <span id="total-final">0.00</span>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header"><i class="bi bi-cash-coin"></i> Pagos Mixtos</div>
                <div class="card-body">
                    <div class="pagos-grid">
                        <div class="form-grupo">
                            <label for="pago_efectivo">Efectivo</label>
                            <input type="number" step="100" min="0" value="0" name="pago_efectivo" id="pago_efectivo" class="form-control pago-input">
                        </div>
                        <div class="form-grupo">
                            <label for="pago_nequi">Nequi</label>
                            <input type="number" step="100" min="0" value="0" name="pago_nequi" id="pago_nequi" class="form-control pago-input">
                        </div>
                        <div class="form-grupo">
                            <label for="pago_daviplata">Daviplata</label>
                            <input type="number" step="100" min="0" value="0" name="pago_daviplata" id="pago_daviplata" class="form-control pago-input">
                        </div>
                        <div class="form-grupo">
                            <label for="pago_transferencia">Transferencia</label>
                            <input type="number" step="100" min="0" value="0" name="pago_transferencia" id="pago_transferencia" class="form-control pago-input">
                        </div>
                        <div class="form-grupo">
                            <label for="pago_tarjeta">Tarjeta/Bold</label>
                            <input type="number" step="100" min="0" value="0" name="pago_tarjeta" id="pago_tarjeta" class="form-control pago-input">
                        </div>
                    </div>

                    <div id="detalles_pago_electronico" class="detalles-pago" style="display:none;">
                        <strong>Referencia de Pago (Obligatoria para Electr贸nicos)</strong>
                        <p class="text-muted small mt-2">
                            * Si hay pagos electr贸nicos (Nequi, Davi, Transf/Tarjeta), debe ingresar el c贸digo antes de finalizar la venta.
                        </p>
                        <div class="form-grupo">
                            <label for="codigo_transaccion">C贸digo de Referencia</label>
                            <input type="text" name="codigo_transaccion" id="codigo_transaccion" class="form-control" placeholder="Ingresa el c贸digo alfanum茅rico aqu铆" oninput="this.value = this.value.toUpperCase()">
                        </div>
                        <div class="form-grupo">
                            <label for="fecha_transaccion">Fecha/Hora de la Transacci贸n (Opcional)</label>
                            <input type="datetime-local" name="fecha_transaccion" id="fecha_transaccion" class="form-control">
                        </div>
                    </div>
                </div>
            </div>

            <button type="submit" class="btn btn-primario"><i class="bi bi-check2-circle"></i> Finalizar Venta</button>
        </form>
    </div>
</div>

<footer>
    POS Cosmetiquer铆a | Todos los derechos reservados &copy; 
    {{ now.year }} 
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // 1. Carga de datos de productos
    const productData = JSON.parse(document.getElementById('product-data').textContent);
    let carrito = {}; 

    $(document).ready(function() {
        $('#manual_producto').select2();
        $('#cliente_id').select2({
            placeholder: "Selecciona o busca un cliente",
            allowClear: true
        });

        // Inicializar evento para mostrar Referencia
        document.querySelectorAll('.pago-input').forEach(input => {
            input.addEventListener('input', toggleDetallesPago);
        });
        
        // Inicializar eventos para actualizar el carrito (siempre que cambie la cantidad)
        document.getElementById('carrito-body').addEventListener('input', function(event) {
            if (event.target.classList.contains('cantidad-input')) {
                const tr = event.target.closest('tr');
                const productoId = parseInt(tr.dataset.productoId);
                const newQuantity = parseInt(event.target.value) || 0;
                
                if (newQuantity <= 0) {
                    eliminarFila(event.target);
                    return;
                }
                
                const producto = productData.find(p => p.id === productoId);
                if (producto) {
                    const newSubtotal = producto.precio * newQuantity;
                    tr.cells[2].textContent = `$${newSubtotal.toFixed(0)}`; 
                    
                    carrito[productoId].cantidad = newQuantity;
                    carrito[productoId].subtotal = newSubtotal;
                }
                actualizarTotal();
            }
        });
        
        // Al cargar la p谩gina, asegurarse de que los campos de pago est茅n a 0 si est谩n vac铆os
        document.querySelectorAll('.pago-input').forEach(input => {
            if (!input.value) input.value = 0;
        });
    });

    // Funci贸n para mostrar/ocultar el campo de referencia
    function toggleDetallesPago() {
        let mostrarReferencia = false;
        const pagosElectronicos = ['pago_nequi', 'pago_daviplata', 'pago_transferencia', 'pago_tarjeta'];
        
        pagosElectronicos.forEach(id => {
            if (parseFloat(document.getElementById(id).value) > 0) {
                mostrarReferencia = true;
            }
        });

        const detallesDiv = document.getElementById('detalles_pago_electronico');
        detallesDiv.style.display = mostrarReferencia ? 'block' : 'none';
    }
    
    // Funci贸n para agregar un producto del men煤 desplegable
    function agregarManual() {
        const select = document.getElementById('manual_producto');
        const cantidad = parseInt(document.getElementById('manual_cantidad').value) || 1;
        const productoId = parseInt(select.value);
        
        if (!productoId) return alert('Seleccione un producto');
        if (cantidad <= 0) return alert('La cantidad debe ser mayor a cero.');

        const producto = productData.find(p => p.id === productoId);
        if (!producto) return;

        // Validar Stock
        const stockActual = producto.stock;
        const cantidadActualEnCarrito = carrito[productoId] ? carrito[productoId].cantidad : 0;
        const cantidadTotalSolicitada = cantidadActualEnCarrito + cantidad;

        if (cantidadTotalSolicitada > stockActual) {
            return alert(`Stock insuficiente. Disponible: ${stockActual}, Solicitado: ${cantidadTotalSolicitada}.`);
        }
        
        if (carrito[productoId]) {
            const nuevaCantidad = carrito[productoId].cantidad + cantidad;
            carrito[productoId].cantidad = nuevaCantidad;
            carrito[productoId].subtotal = producto.precio * nuevaCantidad;
            
            const tr = document.querySelector(`#carrito-body tr[data-producto-id='${productoId}']`);
            tr.querySelector('.cantidad-input').value = nuevaCantidad;
            tr.cells[2].textContent = `$${carrito[productoId].subtotal.toFixed(0)}`;
        } else {
            const subtotal = producto.precio * cantidad;
            carrito[productoId] = {
                id: producto.id,
                nombre: producto.nombre,
                precio: producto.precio,
                cantidad: cantidad,
                subtotal: subtotal
            };
            
            const tbody = document.getElementById('carrito-body');
            const tr = document.createElement('tr');
            tr.dataset.productoId = producto.id;
            tr.innerHTML = `
                <td>${producto.nombre}</td>
                <td><input type="number" value="${cantidad}" min="1" class="form-control cantidad-input"></td>
                <td>$${subtotal.toFixed(0)}</td>
                <td><button type="button" class="btn-rojo" onclick="eliminarFila(this)"><i class="bi bi-trash"></i></button></td>
            `;
            tbody.appendChild(tr);
        }

        document.getElementById('manual_cantidad').value = 1;
        actualizarTotal();
    }
    
    // Funci贸n para eliminar producto
    function eliminarFila(element) {
        const tr = element.closest('tr');
        const productoId = parseInt(tr.dataset.productoId);
        delete carrito[productoId];
        tr.remove();
        actualizarTotal();
    }

    // Funci贸n para recalcular el total
    function actualizarTotal() {
        let total = 0;
        for (const id in carrito) {
            total += carrito[id].subtotal;
        }
        document.getElementById('total-final').textContent = total.toFixed(0);
        toggleDetallesPago(); 
    }
    
    // L贸gica de Esc谩ner
    document.getElementById('escaner_codigo').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            const codigo = this.value.trim();
            if (!codigo) return;
            
            const producto = productData.find(p => p.codigo === codigo);
            if (!producto) return alert(`Producto con c贸digo ${codigo} no encontrado.`);
            
            const productoId = producto.id;
            const cantidad = 1;

            const stockActual = producto.stock;
            const cantidadActualEnCarrito = carrito[productoId] ? carrito[productoId].cantidad : 0;
            const cantidadTotalSolicitada = cantidadActualEnCarrito + cantidad;

            if (cantidadTotalSolicitada > stockActual) {
                return alert(`Stock insuficiente. Disponible: ${stockActual}, Solicitado: ${cantidadTotalSolicitada}.`);
            }

            if (carrito[productoId]) {
                const nuevaCantidad = carrito[productoId].cantidad + cantidad;
                carrito[productoId].cantidad = nuevaCantidad;
                carrito[productoId].subtotal = producto.precio * nuevaCantidad;
                
                const tr = document.querySelector(`#carrito-body tr[data-producto-id='${productoId}']`);
                tr.querySelector('.cantidad-input').value = nuevaCantidad;
                tr.cells[2].textContent = `$${carrito[productoId].subtotal.toFixed(0)}`;
            } else {
                const subtotal = producto.precio * cantidad;
                carrito[productoId] = {
                    id: producto.id,
                    nombre: producto.nombre,
                    precio: producto.precio,
                    cantidad: cantidad,
                    subtotal: subtotal
                };
                
                const tbody = document.getElementById('carrito-body');
                const tr = document.createElement('tr');
                tr.dataset.productoId = producto.id;
                tr.innerHTML = `
                    <td>${producto.nombre}</td>
                    <td><input type="number" value="${cantidad}" min="1" class="form-control cantidad-input"></td>
                    <td>$${subtotal.toFixed(0)}</td>
                    <td><button type="button" class="btn-rojo" onclick="eliminarFila(this)"><i class="bi bi-trash"></i></button></td>
                `;
                tbody.appendChild(tr);
            }
            
            actualizarTotal();
            this.value = ''; // Limpiar el campo del esc谩ner
        }
    });


    // Funci贸n Final de Validaci贸n y Env铆o (BLOQUEA si falta c贸digo en pagos electr贸nicos)
    function validarYEnviar(e) {
        e.preventDefault();
        
        const totalCarrito = parseFloat(document.getElementById('total-final').textContent);
        
        if (totalCarrito <= 0 || Object.keys(carrito).length === 0) {
            return alert('Error: El carrito est谩 vac铆o o el total es cero.');
        }

        const pagoEfectivo = parseFloat(document.getElementById('pago_efectivo').value) || 0;
        const pagoNequi = parseFloat(document.getElementById('pago_nequi').value) || 0;
        const pagoDaviplata = parseFloat(document.getElementById('pago_daviplata').value) || 0;
        const pagoTransferencia = parseFloat(document.getElementById('pago_transferencia').value) || 0;
        const pagoTarjeta = parseFloat(document.getElementById('pago_tarjeta').value) || 0;
        
        const totalPagado = pagoEfectivo + pagoNequi + pagoDaviplata + pagoTransferencia + pagoTarjeta;

        if (Math.round(totalPagado * 100) < Math.round(totalCarrito * 100)) {
            return alert(`Error: El total pagado ($${totalPagado.toFixed(0)}) es menor al total de la venta ($${totalCarrito.toFixed(0)}).`);
        }

        //  LGICA CLAVE: BLOQUEAR SI NO HAY CDIGO MANUAL EN PAGOS ELECTRNICOS
        const tienePagoElectronico = pagoNequi > 0 || pagoDaviplata > 0 || pagoTransferencia > 0 || pagoTarjeta > 0;
        const codTransaccionInput = document.getElementById('codigo_transaccion');
        const codigoManual = codTransaccionInput.value.trim();
        
        if (tienePagoElectronico && !codigoManual) {
            // Bloquea el env铆o y pide la referencia.
            codTransaccionInput.focus();
            return alert('锔 ERROR: Los pagos electr贸nicos (Nequi, Daviplata, Transferencia o Tarjeta) requieren obligatoriamente el C贸digo Alfanum茅rico o N煤mero de Referencia.');
        }
        // ------------------------------------
        
        // Adjuntar campos ocultos al formulario
        const form = document.getElementById('form_venta');
        
        // 1. JSON de productos vendidos
        const carritoJson = JSON.stringify(Object.values(carrito));
        let inputHiddenJson = form.querySelector('input[name="productos_vendidos_json"]');
        if (!inputHiddenJson) {
             inputHiddenJson = document.createElement('input');
             inputHiddenJson.type = 'hidden';
             inputHiddenJson.name = 'productos_vendidos_json';
             form.appendChild(inputHiddenJson);
        }
        inputHiddenJson.value = carritoJson;
        
        // 2. Total de la venta
        let totalInput = form.querySelector('input[name="total_venta"]');
        if (!totalInput) {
             totalInput = document.createElement('input');
             totalInput.type = 'hidden';
             totalInput.name = 'total_venta';
             form.appendChild(totalInput);
        }
        totalInput.value = totalCarrito;

        e.target.submit();
    }
</script>

</body>
</html>