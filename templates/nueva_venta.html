<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nueva Venta - POS La Cosmetiquera</title>
    
    <!-- Incluye Select2, Bootstrap y Font Awesome para dise√±o y funcionalidad -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/css/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <style>
        /* ------------------ PALETA COQUETTE MAGENTA Y NE√ìN ------------------ */
        :root {
            --color-magenta-oscuro-degrade: #880E4F;
            --color-magenta-principal: #E91E63;
            --color-magenta-degrade: #FF4081;
            --color-magenta-suave: #FCE4EC;
            --color-magenta-texto: #AD1457;
            --color-neon-line: #FF80AB;
            --color-navbar: #000000;
            --color-fondo-pagina: #f9fbfd;
            --color-card-fondo: #FFFFFF;
            --color-texto-oscuro: #333333;
            --color-borde-suave: #e0e0e0;
            --color-sombra: rgba(0, 0, 0, 0.1);
            --color-rojo: #dc3545;
            --color-vuelto-positivo: #FFD1DC;
        }

        html { height: 100%; }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--color-fondo-pagina) !important;
            color: var(--color-texto-oscuro);
            display: flex;
            flex-direction: column;
            min-height: 100%; 
        }

        .container-venta {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            max-width: 1400px;
            margin: 20px auto; 
            padding: 0 20px; 
            flex: 1;
        }
        .columna-izquierda {
            flex: 1.5; min-width: 300px; display: flex; flex-direction: column; gap: 20px;
        }
        .columna-derecha {
            flex: 1; 
            min-width: 300px; 
            display: flex; 
            flex-direction: column; 
            gap: 20px;
        }

        .navbar-custom {
            background-color: var(--color-navbar); 
        }
        
        .card {
            background-color: var(--color-card-fondo);
            border-radius: 15px; 
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            border: 1px solid var(--color-borde-suave);
        }
        
        .card-header {
            background: linear-gradient(90deg, var(--color-magenta-oscuro-degrade) 0%, var(--color-magenta-principal) 100%);
            color: white;
            padding: 15px 20px;
            font-size: 1.15rem;
            font-weight: 600;
            border-bottom: none;
            display: flex;
            align-items: center;
        }

        .form-control, .form-select, .select2-container--bootstrap-5 .select2-selection {
            padding: 12px;
            border: 1px solid var(--color-borde-suave);
            border-radius: 8px !important;
            transition: all 0.2s;
        }

        .form-control:focus, .form-select:focus, .select2-container--bootstrap-5.select2-container--focus .select2-selection {
            outline: none;
            border-color: var(--color-neon-line) !important;
            box-shadow: 0 0 8px 1px rgba(255, 128, 171, 0.7) !important; 
        }
        
        .form-grupo label {
            color: var(--color-magenta-texto); 
            font-weight: 600;
            margin-bottom: 5px;
        }

        .btn-primario {
            background-color: var(--color-magenta-principal);
            color: white;
            width: 100%;
            padding: 12px 20px;
            font-size: 1.05rem;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(233, 30, 99, 0.6); 
            transition: all 0.2s ease;
            text-transform: uppercase;
        }

        .btn-primario:hover {
            background-color: var(--color-magenta-oscuro-degrade);
            box-shadow: 0 6px 20px rgba(233, 30, 99, 0.8);
            transform: translateY(-1px);
        }
        
        .resumen-total {
            text-align: right;
            font-size: 2rem;
            font-weight: 700;
            color: var(--color-magenta-principal);
            margin-top: 5px;
            padding-top: 15px;
            border-top: 3px solid var(--color-magenta-suave);
            letter-spacing: 1px;
            background-color: var(--color-magenta-suave);
            border-radius: 10px;
            padding: 15px;
        }
        
        #contenedor-vuelto {
            margin-top: 25px;
            padding: 15px;
            background-color: #37474F;
            color: white;
            border-radius: 10px;
            text-align: center;
            font-size: 1.5rem;
            font-weight: 700;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        #vuelto-monto {
            font-size: 2rem;
            display: block;
            margin-top: 5px;
        }
        
        #carrito-card-body {
            min-height: 250px; 
            max-height: 40vh;
            overflow-y: auto; 
            padding-bottom: 0;
            padding-top: 0;
            padding-left: 20px;
            padding-right: 20px;
        }
        
        #form_venta > .card:first-child {
            flex-grow: 1; 
        }

        .tabla thead th {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .tabla tbody td {
            white-space: normal; 
            word-wrap: break-word;
        }

        .tabla th:nth-child(1), .tabla td:nth-child(1) {
            width: 55%; 
        }

        /* üî• NUEVO: bloque de c√≥digos electr√≥nicos */
        #detalles_pago_electronico {
            margin-top: 18px;
            padding: 14px;
            border-radius: 10px;
            background: #fff7fb;
            border: 1px dashed var(--color-neon-line);
        }
        #detalles_pago_electronico strong {
            color: var(--color-magenta-oscuro-degrade);
        }
        .codigo-metodo {
            display: none;
            margin-top: 10px;
        }

        footer {
            background-color: var(--color-navbar); 
            color: white; 
            padding: 10px 0; 
            text-align: center;
            margin-top: auto; 
            font-size: 0.9rem;
            width: 100%; 
        }
    </style>
</head>
<body>

{% if current_user.is_authenticated %}
<nav class="navbar navbar-expand-lg navbar-dark navbar-custom">
    <div class="container-fluid">
        <a class="navbar-brand d-flex align-items-center" href="{{ url_for('dashboard') or url_for('clientes') }}">
            <i class="fas fa-gem me-2"></i> 
            LA COSMETIQUERA DE GABI
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
            aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav mx-auto mb-2 mb-lg-0">
                <li class="nav-item"><a class="nav-link" href="{{ url_for('inventario') }}">Inventario</a></li>
                <li class="nav-item"><a class="nav-link" href="{{ url_for('clientes') }}">Clientes</a></li>
                <li class="nav-item"><a class="nav-link active" aria-current="page" href="{{ url_for('nueva_venta') }}">Ventas Diarias</a></li> 
                {% if current_user.rol.lower() == 'administrador' %}
                <li class="nav-item"><a class="nav-link" href="{{ url_for('reportes') }}">Cierre / Informes</a></li>
                <li class="nav-item"><a class="nav-link" href="{{ url_for('usuarios') }}">Gesti√≥n de Usuarios</a></li>
                {% endif %}
            </ul>
            <span class="navbar-text me-3 text-white">
                Hola, {{ current_user.username }}
                <span class="badge text-bg-light">{{ current_user.rol }}</span>
            </span>
            <a class="btn btn-sm btn-light text-dark" href="{{ url_for('logout') }}">Cerrar Sesi√≥n</a>
        </div>
    </div>
</nav>
{% endif %}

<script id="product-data" type="application/json">
[
    {% for p in productos %}
    {
        "id": {{ p.id }},
        "nombre": {{ p.nombre | tojson }},
        "codigo": "{{ p.codigo }}",
        "precio": {{ p.valor_venta }},
        "stock": {{ p.cantidad }}
    }
    {% if not loop.last %},{% endif %}
    {% endfor %}
]
</script>

<div class="container-venta">
    <div class="columna-izquierda">

        <div class="card">
            <div class="card-header"><i class="fas fa-barcode me-2"></i> ESCANEAR PRODUCTO</div>
            <div class="card-body">
                <div class="form-grupo">
                    <input type="text" id="escaner_codigo" class="form-control" placeholder="Escanee el c√≥digo aqu√≠ y presione Enter...">
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header"><i class="fas fa-boxes me-2"></i> A√±adir Productos Manualmente</div>
            <div class="card-body">
                <div class="form-grupo">
                    <label for="manual_producto">Producto</label>
                    <select name="producto" id="manual_producto" class="form-select" data-bs-theme="bootstrap-5">
                        <option value="">-- Seleccionar Producto --</option>
                        {% for p in productos %}
                        <option value="{{ p.id }}" data-precio-venta="{{ p.valor_venta }}">
                            {{ p.nombre }} - {{ p.descripcion }} | (${{ p.valor_venta|format_number }}) - Stock: {{ p.cantidad }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-grupo">
                    <label for="manual_cantidad">Cantidad</label>
                    <input type="number" id="manual_cantidad" class="form-control" value="1" min="1">
                </div>
                <button type="button" class="btn btn-primario" onclick="agregarManual()">
                    <i class="fas fa-plus-circle me-2"></i> Agregar Manual
                </button>
            </div>
        </div>

        <div class="card">
            <div class="card-header"><i class="fas fa-user-tag me-2"></i> Selecci√≥n de Cliente</div>
            <div class="card-body">
                <div class="form-grupo">
                    <label for="cliente_id">Cliente para la Venta</label>
                    <select name="cliente_id" id="cliente_id" class="form-select" form="form_venta" data-bs-theme="bootstrap-5"> 
                        {% for cliente in clientes %}
                            <option value="{{ cliente.id }}" {% if cliente.id == 1 %}selected{% endif %}>{{ cliente.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>

    </div>

    <div class="columna-derecha">
        <form method="POST" id="form_venta" onsubmit="return validarYEnviar(event)" style="display: flex; flex-direction: column; gap: 20px; height: 100%;">
            
            <!-- TARJETA DEL CARRITO -->
            <div class="card" style="flex-grow: 1;">
                <div class="card-header"><i class="fas fa-shopping-cart me-2"></i> Resumen de Carrito</div>
                
                <div class="card-body" id="carrito-card-body">
                    <div class="table-responsive">
                        <table class="table table-hover tabla">
                            <thead>
                                <tr>
                                    <th style="width: 55%;">Item</th>
                                    <th style="width: 15%;">Cant.</th>
                                    <th style="width: 25%; text-align: right;">Subtotal</th>
                                    <th style="width: 5%;"></th>
                                </tr>
                            </thead>
                            <tbody id="carrito-body"></tbody>
                        </table>
                    </div>
                </div>
                <div class="p-3">
                    <div class="resumen-total">
                        TOTAL A PAGAR: $ <span id="total-final" data-raw-total="0">0</span>
                    </div>
                </div>
            </div>

            <!-- TARJETA DE PAGOS Y VUELTO -->
            <div class="card">
                <div class="card-header"><i class="fas fa-cash-register me-2"></i> Pagos y Vuelto</div>
                <div class="card-body">
                    <div class="pagos-grid">
                        <div class="form-grupo">
                            <label for="pago_efectivo"><i class="fas fa-money-bill-wave me-1"></i> Efectivo</label>
                            <input type="number" step="100" min="0" value="0" name="pago_efectivo" id="pago_efectivo" class="form-control pago-input">
                        </div>
                        <div class="form-grupo">
                            <label for="pago_nequi"><i class="fas fa-mobile-alt me-1"></i> Nequi</label>
                            <input type="number" step="100" min="0" value="0" name="pago_nequi" id="pago_nequi" class="form-control pago-input">
                        </div>
                        <div class="form-grupo">
                            <label for="pago_daviplata"><i class="fas fa-mobile-alt me-1"></i> Daviplata</label>
                            <input type="number" step="100" min="0" value="0" name="pago_daviplata" id="pago_daviplata" class="form-control pago-input">
                        </div>
                        <div class="form-grupo">
                            <label for="pago_transferencia"><i class="fas fa-university me-1"></i> Transferencia</label>
                            <input type="number" step="100" min="0" value="0" name="pago_transferencia" id="pago_transferencia" class="form-control pago-input">
                        </div>
                        <div class="form-grupo">
                            <label for="pago_tarjeta"><i class="fas fa-credit-card me-1"></i> Tarjeta/Bold</label>
                            <input type="number" step="100" min="0" value="0" name="pago_tarjeta" id="pago_tarjeta" class="form-control pago-input">
                        </div>
                    </div>

                    <!-- Contenedor de Vuelto -->
                    <div id="contenedor-vuelto">
                        <span style="font-size: 1.2rem; font-weight: 500;">VUELTO A DEVOLVER:</span>
                        <span id="vuelto-monto">$ 0</span>
                    </div>

                    <!-- üî• OPCI√ìN C: C√≥digos por m√©todo -->
                    <div id="detalles_pago_electronico" style="display:none;">
                        <strong><i class="fas fa-qrcode me-1"></i> Referencias obligatorias por m√©todo electr√≥nico</strong>
                        <p class="text-muted small mt-2">
                            * Si usas Nequi/Davi/Transferencia/Tarjeta, debes ingresar su c√≥digo correspondiente.
                        </p>

                        <div class="form-grupo codigo-metodo" id="codigo-nequi-box">
                            <label for="codigo_nequi">üì± C√≥digo Nequi</label>
                            <input type="text" id="codigo_nequi" class="form-control codigo-input"
                                   placeholder="Ej: NEQ123ABC" oninput="this.value = this.value.toUpperCase()">
                        </div>

                        <div class="form-grupo codigo-metodo" id="codigo-daviplata-box">
                            <label for="codigo_daviplata">üü† C√≥digo Daviplata</label>
                            <input type="text" id="codigo_daviplata" class="form-control codigo-input"
                                   placeholder="Ej: DAV456XYZ" oninput="this.value = this.value.toUpperCase()">
                        </div>

                        <div class="form-grupo codigo-metodo" id="codigo-transferencia-box">
                            <label for="codigo_transferencia">üè¶ C√≥digo Transferencia</label>
                            <input type="text" id="codigo_transferencia" class="form-control codigo-input"
                                   placeholder="Ej: TRF789KLM" oninput="this.value = this.value.toUpperCase()">
                        </div>

                        <div class="form-grupo codigo-metodo" id="codigo-tarjeta-box">
                            <label for="codigo_tarjeta">üí≥ C√≥digo Tarjeta/Bold</label>
                            <input type="text" id="codigo_tarjeta" class="form-control codigo-input"
                                   placeholder="Ej: BOLD001QWE" oninput="this.value = this.value.toUpperCase()">
                        </div>

                        <div class="form-grupo mt-2">
                            <label for="fecha_transaccion">Fecha/Hora Transacci√≥n (Opcional)</label>
                            <input type="datetime-local" name="fecha_transaccion" id="fecha_transaccion" class="form-control">
                        </div>
                    </div>

                    <!-- Hidden para backend (compatibilidad + JSON referencias) -->
                    <input type="hidden" name="codigo_transaccion" id="codigo_transaccion">
                    <input type="hidden" name="referencias_pago_json" id="referencias_pago_json">
                </div>
            </div>

            <button type="submit" class="btn btn-primario"><i class="fas fa-check-circle me-2"></i> Finalizar Venta</button>
        </form>
    </div>
</div>

<footer>
    <p class="mb-0">POS Cosmetiquer√≠a | Todos los derechos reservados &copy; {{ now.year }}</p> 
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // ---------------------- FUNCIONES DE UTILIDAD Y CORE ----------------------
    const productData = JSON.parse(document.getElementById('product-data').textContent);
    let carrito = {}; 

    function formatCurrency(value) {
        if (typeof value === 'string') value = parseFloat(value);
        return value.toLocaleString('es-CO', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
    }

    // ‚úÖ Mostrar/ocultar campos por m√©todo + c√°lculo de vuelto
    function toggleDetallesPago() {
        let mostrarReferencia = false;
        let totalPagado = 0;

        const pagosElectronicos = [
            { id: 'pago_nequi', box: 'codigo-nequi-box', input: 'codigo_nequi', label: 'Nequi' },
            { id: 'pago_daviplata', box: 'codigo-daviplata-box', input: 'codigo_daviplata', label: 'Daviplata' },
            { id: 'pago_transferencia', box: 'codigo-transferencia-box', input: 'codigo_transferencia', label: 'Transferencia' },
            { id: 'pago_tarjeta', box: 'codigo-tarjeta-box', input: 'codigo_tarjeta', label: 'Tarjeta/Bold' },
        ];

        pagosElectronicos.forEach(m => {
            const monto = parseFloat(document.getElementById(m.id).value) || 0;
            totalPagado += monto;

            const box = document.getElementById(m.box);
            const inp = document.getElementById(m.input);

            if (monto > 0) {
                mostrarReferencia = true;
                box.style.display = 'block';
                inp.setAttribute('required', 'required');
            } else {
                box.style.display = 'none';
                inp.removeAttribute('required');
                inp.value = '';
            }
        });

        const pagoEfectivo = parseFloat(document.getElementById('pago_efectivo').value) || 0;
        totalPagado += pagoEfectivo;

        const totalCarrito = parseFloat(document.getElementById('total-final').dataset.rawTotal) || 0;
        const efectivoParaVuelto = pagoEfectivo;

        let vuelto = 0;
        const pagosNoEfectivo = totalPagado - efectivoParaVuelto;
        const restantePorCubrirEnEfectivo = totalCarrito - pagosNoEfectivo;

        if (restantePorCubrirEnEfectivo > 0 && efectivoParaVuelto >= restantePorCubrirEnEfectivo) {
            vuelto = efectivoParaVuelto - restantePorCubrirEnEfectivo;
        } else if (restantePorCubrirEnEfectivo <= 0 && totalPagado > totalCarrito) {
            vuelto = totalPagado - totalCarrito;
        }

        if (totalPagado < totalCarrito) {
            vuelto = 0;
        }

        const $vueltoMonto = $('#vuelto-monto');
        $vueltoMonto.text(`$ ${formatCurrency(vuelto)}`);

        if (vuelto > 0) {
            $vueltoMonto.css('color', 'var(--color-vuelto-positivo)');
            $vueltoMonto.css('text-shadow', '0 0 5px rgba(255, 209, 220, 0.8)');
        } else if (totalPagado < totalCarrito) {
            $vueltoMonto.text(`$ 0 (Faltan $${formatCurrency(totalCarrito - totalPagado)})`);
            $vueltoMonto.css('color', 'var(--color-magenta-principal)');
            $vueltoMonto.css('text-shadow', 'none');
        } else {
            $vueltoMonto.css('color', 'white');
            $vueltoMonto.css('text-shadow', '0 0 3px rgba(255,255,255,0.4)');
        }

        document.getElementById('detalles_pago_electronico').style.display = mostrarReferencia ? 'block' : 'none';
        return { totalPagado, totalCarrito, vuelto };
    }

    function agregarManual() {
        const select = document.getElementById('manual_producto');
        const cantidad = parseInt(document.getElementById('manual_cantidad').value) || 1;
        const productoId = parseInt(select.value);

        if (!productoId) return alert('Seleccione un producto.');
        if (cantidad <= 0) return alert('La cantidad debe ser mayor a cero.');

        const selectedOption = select.options[select.selectedIndex];
        const precioPuro = parseFloat(selectedOption.dataset.precioVenta) || 0;

        const producto = productData.find(p => p.id === productoId);
        if (!producto) return;

        const stockActual = producto.stock;
        const cantidadActualEnCarrito = carrito[productoId] ? carrito[productoId].cantidad : 0;
        const cantidadTotalSolicitada = cantidadActualEnCarrito + cantidad;

        if (cantidadTotalSolicitada > stockActual) {
            return alert(`Stock insuficiente. Disponible: ${stockActual}, Solicitado: ${cantidadTotalSolicitada}.`);
        }

        if (carrito[productoId]) {
            const nuevaCantidad = carrito[productoId].cantidad + cantidad;
            carrito[productoId].cantidad = nuevaCantidad;
            carrito[productoId].subtotal = precioPuro * nuevaCantidad;
        } else {
            const subtotal = precioPuro * cantidad;
            carrito[productoId] = {
                id: producto.id,
                nombre: producto.nombre,
                precio: precioPuro,
                cantidad: cantidad,
                subtotal: subtotal
            };
        }

        document.getElementById('manual_cantidad').value = 1;
        renderizarCarrito();
    }

    function eliminarFila(element) {
        const tr = element.closest('tr');
        const productoId = parseInt(tr.dataset.productoId);
        delete carrito[productoId];
        renderizarCarrito();
    }

    function renderizarCarrito() {
        const tbody = document.getElementById('carrito-body');
        tbody.innerHTML = '';
        let total = 0;

        for (const id in carrito) {
            const item = carrito[id];
            const producto = productData.find(p => p.id === item.id);
            if (!producto) continue;

            item.subtotal = item.precio * item.cantidad;
            total += item.subtotal;

            const tr = document.createElement('tr');
            tr.dataset.productoId = item.id;
            tr.innerHTML = `
                <td>${item.nombre}</td>
                <td>
                    <input type="number" value="${item.cantidad}" min="1" max="${producto.stock}"
                           class="form-control form-control-sm cantidad-input"
                           style="width: 70px; display: inline-block; text-align: center;">
                </td>
                <td style="text-align: right;" class="fw-bold text-success">$${formatCurrency(item.subtotal)}</td>
                <td>
                    <button type="button" class="btn-rojo" onclick="eliminarFila(this)" title="Eliminar art√≠culo">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        }

        document.getElementById('total-final').textContent = formatCurrency(total);
        document.getElementById('total-final').dataset.rawTotal = total;

        toggleDetallesPago();
    }

    // ---------------------- EVENTOS ----------------------
    $(document).ready(function() {
        $('#manual_producto').select2({ theme: 'bootstrap-5' });
        $('#cliente_id').select2({
            theme: 'bootstrap-5',
            placeholder: "Selecciona o busca un cliente",
            allowClear: true
        });

        document.querySelectorAll('.pago-input').forEach(input => {
            input.addEventListener('input', toggleDetallesPago);
        });

        document.getElementById('carrito-body').addEventListener('input', function(event) {
            if (event.target.classList.contains('cantidad-input')) {
                const tr = event.target.closest('tr');
                const productoId = parseInt(tr.dataset.productoId);
                let newQuantity = parseInt(event.target.value) || 0;

                const producto = productData.find(p => p.id === productoId);
                const maxStock = producto ? producto.stock : 0;

                if (newQuantity > maxStock) {
                    alert(`Stock insuficiente. M√°ximo disponible: ${maxStock}.`);
                    newQuantity = maxStock;
                    event.target.value = maxStock;
                }

                if (newQuantity <= 0) {
                    eliminarFila(event.target);
                    return;
                }

                if (producto) {
                    carrito[productoId].cantidad = newQuantity;
                }
                renderizarCarrito();
            }
        });

        document.querySelectorAll('.pago-input').forEach(input => {
            if (!input.value) input.value = 0;
        });

        renderizarCarrito();
    });

    // Esc√°ner
    document.getElementById('escaner_codigo').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            const codigo = this.value.trim();
            this.value = '';
            if (!codigo) return;

            const producto = productData.find(p => p.codigo === codigo);
            if (!producto) return alert(`Producto con c√≥digo ${codigo} no encontrado.`);

            const productoId = producto.id;
            const cantidad = 1;

            const stockActual = producto.stock;
            const cantidadActualEnCarrito = carrito[productoId] ? carrito[productoId].cantidad : 0;
            const cantidadTotalSolicitada = cantidadActualEnCarrito + cantidad;

            if (cantidadTotalSolicitada > stockActual) {
                return alert(`Stock insuficiente. Disponible: ${stockActual}, Solicitado: ${cantidadTotalSolicitada}.`);
            }

            if (carrito[productoId]) {
                carrito[productoId].cantidad += cantidad;
            } else {
                carrito[productoId] = {
                    id: producto.id,
                    nombre: producto.nombre,
                    precio: producto.precio,
                    cantidad: cantidad,
                    subtotal: 0
                };
            }

            renderizarCarrito();
        }
    });

    // ‚úÖ Validaci√≥n final
    function validarYEnviar(e) {
        e.preventDefault();

        const { totalPagado, totalCarrito, vuelto } = toggleDetallesPago();

        if (totalCarrito <= 0 || Object.keys(carrito).length === 0) {
            return alert('Error: El carrito est√° vac√≠o o el total es cero.');
        }

        if (Math.round(totalPagado * 100) < Math.round(totalCarrito * 100)) {
            return alert(`Error: El total pagado ($${formatCurrency(totalPagado)}) es menor al total de la venta ($${formatCurrency(totalCarrito)}).`);
        }

        // ‚úÖ Validar c√≥digos POR M√âTODO ELECTR√ìNICO
        const referencias = {};
        const metodos = [
            { pagoId: 'pago_nequi', codeId: 'codigo_nequi', name: 'Nequi' },
            { pagoId: 'pago_daviplata', codeId: 'codigo_daviplata', name: 'Daviplata' },
            { pagoId: 'pago_transferencia', codeId: 'codigo_transferencia', name: 'Transferencia' },
            { pagoId: 'pago_tarjeta', codeId: 'codigo_tarjeta', name: 'Tarjeta/Bold' },
        ];

        for (const m of metodos) {
            const monto = parseFloat(document.getElementById(m.pagoId).value) || 0;
            if (monto > 0) {
                const codeVal = (document.getElementById(m.codeId).value || '').trim();
                if (!codeVal) {
                    document.getElementById(m.codeId).focus();
                    return alert(`‚ö†Ô∏è ERROR: Debes ingresar el c√≥digo para ${m.name}.`);
                }
                referencias[m.name] = codeVal.toUpperCase();
            }
        }

        // Guardar referencias en hidden JSON para backend
        document.getElementById('referencias_pago_json').value = JSON.stringify(referencias);

        // Compatibilidad: un solo campo concatenado
        const concatenado = Object.entries(referencias).map(([k,v]) => `${k}:${v}`).join(" | ");
        document.getElementById('codigo_transaccion').value = concatenado;

        // Adjuntar campos ocultos al formulario
        const form = document.getElementById('form_venta');

        const carritoJson = JSON.stringify(Object.values(carrito).filter(item => item.cantidad > 0));
        let inputHiddenJson = form.querySelector('input[name="productos_vendidos_json"]');
        if (!inputHiddenJson) {
             inputHiddenJson = document.createElement('input');
             inputHiddenJson.type = 'hidden';
             inputHiddenJson.name = 'productos_vendidos_json';
             form.appendChild(inputHiddenJson);
        }
        inputHiddenJson.value = carritoJson;

        let totalInput = form.querySelector('input[name="total_venta"]');
        if (!totalInput) {
             totalInput = document.createElement('input');
             totalInput.type = 'hidden';
             totalInput.name = 'total_venta';
             form.appendChild(totalInput);
        }
        totalInput.value = totalCarrito;

        // ‚úÖ Si hay vuelto, se registra igual sin confirmaci√≥n
        console.log("Venta con vuelto permitido:", vuelto);

        e.target.submit();
    }
</script>

</body>
</html>
