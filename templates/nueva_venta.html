<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nueva Venta - POS Cosmetiquería</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --color-primario: #c71585; 
            --color-primario-hover: #a6126f;
            background: linear-gradient(160deg, #f9e8f1 0%, #ffffff 100%); /* <-- Fondo Rosa Pálido */
            --color-card: #FFFFFF;
            --color-card-header: #37474F; 
            --color-card-header-texto: #FFFFFF;
            --color-texto: #333;
            --color-borde: #E0E0E0;
            --color-rojo: #D32F2F;
            --color-rojo-hover: #C62828;
        }

        html { height: 100%; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", sans-serif;
            background-color: var(--color-fondo) !important; /* <-- Forzamos el fondo rosa */
            color: var(--color-texto);
            display: flex;
            flex-direction: column;
            min-height: 100%; 
        }

        /* Contenedor principal de la venta */
        .container-venta {
            display: flex;
            flex-wrap: wrap; /* Para móviles */
            gap: 20px;
            max-width: 1400px;
            margin: 20px auto; 
            padding: 0 20px; 
            flex: 1; /* Empuja el footer */
        }

        .columna-izquierda {
            flex: 1.5;
            display: flex;
            flex-direction: column;
            gap: 20px;
            min-width: 300px;
        }

        .columna-derecha {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
            min-width: 300px;
        }

        /* Diseño de las tarjetas internas */
        .card {
            background-color: var(--color-card);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            border: none;
        }

        .card-header {
            background-color: var(--color-card-header);
            color: var(--color-card-header-texto);
            padding: 15px 20px;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .card-body {
            padding: 20px;
        }

        .form-grupo {
            margin-bottom: 15px;
        }

        .form-grupo label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }

        .form-control, .form-select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--color-borde);
            border-radius: 8px;
            box-sizing: border-box; 
            font-size: 1rem;
            background-color: #FFFFFF;
            color: #333;
        }

        .form-control:focus, .form-select:focus {
            outline: none;
            border-color: var(--color-primario);
            box-shadow: 0 0 0 2px rgba(199, 21, 133, 0.2);
        }

        .btn-primario {
            background-color: var(--color-primario);
            color: white;
            width: 100%;
            padding: 12px 20px;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            text-decoration: none;
            transition: background-color 0.2s ease;
        }

        .btn-primario:hover {
            background-color: var(--color-primario-hover);
        }

        .btn-rojo {
            background-color: var(--color-rojo);
            color: white;
            padding: 5px 10px;
            font-size: 0.8rem;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        .btn-rojo:hover {
            background-color: var(--color-rojo-hover);
        }

        .tabla {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .tabla th, .tabla td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--color-borde);
        }

        .tabla th {
            background-color: #F9F9F9;
            font-weight: 600;
            color: #444;
        }

        .tabla td {
            vertical-align: middle;
        }

        .resumen-total {
            text-align: right;
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--color-primario);
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px dashed var(--color-primario);
        }

        .pagos-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .detalles-pago {
            display: none; 
            margin-top: 15px;
            border-top: 1px dashed #ccc;
            padding-top: 15px;
            background-color: #fafafa;
            padding: 10px;
            border-radius: 8px;
        }
        .detalles-pago strong {
            color: var(--color-primario);
            font-size: 0.9rem;
        }

        /* ARREGLO PARA EL 5º CAMPO DE PAGO */
        .pagos-grid .form-grupo:last-child:nth-child(odd) {
            grid-column: 1 / -1; 
        }

        /* Estilo para el footer (copiado de tu base.html) */
        footer {
            background-color: var(--color-secundario); 
            color: var(--color-texto-claro); 
            padding: 10px 0; 
            text-align: center;
            margin-top: auto; 
            font-size: 0.9rem;
            width: 100%; 
        }
        footer a {
            font-weight: 600;
            color: var(--color-texto-claro); 
            text-decoration: none;
        }
        footer a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>

    {% if current_user.is_authenticated %}
    <nav class="navbar navbar-expand-lg navbar-dark navbar-custom">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="{{ url_for('dashboard') or url_for('clientes') }}">
                <img src="{{ url_for('static', filename='img/LOGO.png') }}" alt="Logo" style="height:40px; margin-right:8px;">
                LA COSMETIQUERA DE GABI
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav mx-auto mb-2 mb-lg-0">
                    <li class="nav-item"><a class="nav-link" href="{{ url_for('inventario') }}">Inventario</a></li>
                    <li class="nav-item"><a class="nav-link" href="{{ url_for('clientes') }}">Clientes</a></li>
                    <li class="nav-item"><a class="nav-link active" aria-current="page" href="{{ url_for('nueva_venta') }}">Ventas Diarias</a></li> 
                    {% if current_user.rol.lower() == 'administrador' %}
                    <li class="nav-item"><a class="nav-link" href="{{ url_for('reportes') }}">Cierre / Informes</a></li>
                    <li class="nav-item"><a class="nav-link" href="{{ url_for('usuarios') }}">Gestión de Usuarios</a></li>
                    {% endif %}
                </ul>
                <span class="navbar-text me-3 text-white">
                    Hola, {{ current_user.username }}
                    <span class="badge bg-white text-dark">{{ current_user.rol }}</span>
                </span>
                <a class="btn btn-primary" href="{{ url_for('logout') }}">Cerrar Sesión</a>
            </div>
        </div>
    </nav>
    {% endif %}

    <script id="product-data" type="application/json">
        [
          {% for p in productos %}
          {
            "id": {{ p.id }},
            "nombre": {{ p.nombre | tojson }},
            "codigo": "{{ p.codigo }}",
            "precio": {{ p.valor_venta }},
            "stock": {{ p.cantidad }}
          }
          {% if not loop.last %},{% endif %}
          {% endfor %}
        ]
    </script>

    <div class="container-venta">
        
        <div class="columna-izquierda">
            
            <div class="card">
                <div class="card-header"><i class="bi bi-upc-scan"></i> ESCANEAR PRODUCTO (Lector o Manual)</div>
                <div class="card-body">
                    <div class="form-grupo">
                        <input type="text" id="escaner_codigo" class="form-control" placeholder="Escanee el código aquí y presione Enter...">
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header"><i class="bi bi-person-plus"></i> Añadir Productos Manualmente</div>
                <div class="card-body">
                    <div class="form-grupo">
                        <label for="manual_producto">Producto</label>
                        <select id="manual_producto" class="form-select">
                            <option value="">-- Seleccionar Producto --</option>
                            {% for p in productos %}
                                <option value="{{ p.id }}">
                                    {{ p.nombre }} (${{ "%.0f"|format(p.valor_venta) }}) - Stock: {{ p.cantidad }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-grupo">
                        <label for="manual_cantidad">Cantidad</label>
                        <input type="number" id="manual_cantidad" class="form-control" value="1" min="1">
                    </div>
                    <button type="button" class="btn btn-primario" onclick="agregarManual()">
                        <i class="bi bi-plus-circle"></i> Agregar Manual
                    </button>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header"><i class="bi bi-person"></i> Selección de Cliente</div>
                <div class="card-body">
                    <div class="form-grupo">
                        <select name="cliente_id" id="cliente_id" class="form-select" form="form_venta"> 
                            {% for cliente in clientes %}
                                <option value="{{ cliente.id }}">{{ cliente.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>

        </div>

        <div class="columna-derecha">
            
            <form method="POST" id="form_venta" onsubmit="return validarYEnviar(event)" style="display: flex; flex-direction: column; gap: 20px;">

                <div class="card">
                    <div class="card-header"><i class="bi bi-cart3"></i> Resumen de Carrito</div>
                    <div class="card-body">
                        <table class="tabla">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Cant.</th>
                                    <th>Subtotal</th>
                                    <th>Acción</th>
                                </tr>
                            </thead>
                            <tbody id="carrito-body">
                                </tbody>
                        </table>
                        <div class="resumen-total">
                            TOTAL: $ <span id="total-final">0.00</span>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header"><i class="bi bi-cash-coin"></i> Pagos Mixtos</div>
                    <div class="card-body">
                        
                        <div class="pagos-grid">
                            <div class="form-grupo">
                                <label for="pago_efectivo">Efectivo</label>
                                <input type="number" step="100" min="0" value="0" name="pago_efectivo" id="pago_efectivo" class="form-control pago-input">
                            </div>
                            <div class="form-grupo">
                                <label for="pago_nequi">Nequi</label>
                                <input type="number" step="100" min="0" value="0" name="pago_nequi" id="pago_nequi" class="form-control pago-input">
                            </div>
                            <div class="form-grupo">
                                <label for="pago_daviplata">Daviplata</label>
                                <input type="number" step="100" min="0" value="0" name="pago_daviplata" id="pago_daviplata" class="form-control pago-input">
                            </div>
                            <div class="form-grupo">
                                <label for="pago_transferencia">Transferencia</label>
                                <input type="number" step="100" min="0" value="0" name="pago_transferencia" id="pago_transferencia" class="form-control pago-input">
                            </div>
                            <div class="form-grupo">
                                <label for="pago_tarjeta">Tarjeta/Bold</label>
                                <input type="number" step="100" min="0" value="0" name="pago_tarjeta" id="pago_tarjeta" class="form-control pago-input">
                            </div>
                        </div>

                        <div id="detalles_efectivo" class="detalles-pago">
                            <strong>Detalles Efectivo</strong>
                            <div class="form-grupo">
                                <label for="codigo_efectivo">Ref. Efectivo (Opcional)</label>
                                <input type="text" name="codigo_efectivo" id="codigo_efectivo" class="form-control" placeholder="Ej: Denominación billete, etc.">
                            </div>
                            <div class="form-grupo">
                                <label for="fecha_efectivo">Fecha Efectivo</label>
                                <input type="datetime-local" name="fecha_efectivo" id="fecha_efectivo" class="form-control">
                            </div>
                        </div>
                        <div id="detalles_nequi" class="detalles-pago">
                            <strong>Detalles Nequi</strong>
                            <div class="form-grupo">
                                <label for="codigo_nequi">Código Nequi</label>
                                <input type="text" name="codigo_nequi" id="codigo_nequi" class="form-control" placeholder="Requerido si paga con Nequi">
                            </div>
                            <div class="form-grupo">
                                <label for="fecha_nequi">Fecha Nequi</label>
                                <input type="datetime-local" name="fecha_nequi" id="fecha_nequi" class="form-control">
                            </div>
                        </div>
                        <div id="detalles_daviplata" class="detalles-pago">
                            <strong>Detalles Daviplata</strong>
                            <div class="form-grupo">
                                <label for="codigo_daviplata">Código Daviplata</label>
                                <input type="text" name="codigo_daviplata" id="codigo_daviplata" class="form-control" placeholder="Requerido si paga con Daviplata">
                            </div>
                            <div class="form-grupo">
                                <label for="fecha_daviplata">Fecha Daviplata</label>
                                <input type="datetime-local" name="fecha_daviplata" id="fecha_daviplata" class="form-control">
                            </div>
                        </div>
                        <div id="detalles_transferencia" class="detalles-pago">
                            <strong>Detalles Transferencia</strong>
                            <div class="form-grupo">
                                <label for="codigo_transferencia">Código Transferencia</label>
                                <input type="text" name="codigo_transferencia" id="codigo_transferencia" class="form-control" placeholder="Requerido si paga con Transferencia">
                            </div>
                            <div class="form-grupo">
                                <label for="fecha_transferencia">Fecha Transferencia</label>
                                <input type="datetime-local" name="fecha_transferencia" id="fecha_transferencia" class="form-control">
                            </div>
                        </div>
                        <div id="detalles_tarjeta" class="detalles-pago">
                            <strong>Detalles Tarjeta/Bold</strong>
                            <div class="form-grupo">
                                <label for="codigo_tarjeta">Código Tarjeta/Bold</label>
                                <input type="text" name="codigo_tarjeta" id="codigo_tarjeta" class="form-control" placeholder="Requerido si paga con Tarjeta">
                            </div>
                            <div class="form-grupo">
                                <label for="fecha_tarjeta">Fecha Tarjeta</label>
                                <input type="datetime-local" name="fecha_tarjeta" id="fecha_tarjeta" class="form-control">
                            </div>
                        </div>

                        <div class="resumen-total" style="font-size: 1.2rem; color: #555; margin-top: 15px;">
                            Monto Pendiente: $ <span id="monto-pendiente">0.00</span>
                        </div>
                        
                        <input type="hidden" name="productos_vendidos_json" id="productos_vendidos_json">
                        <input type="hidden" name="total_venta" id="total_venta_hidden">

                        <button type="submit" class="btn btn-primario" style="margin-top: 20px;">
                            <i class="bi bi-check-lg"></i> PROCESAR PAGO
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <footer>
        <div>Creado por: Lorena Rodriguez Ramos</div>
        <div>Email: <a href="mailto:lorenarodriguezr155@gmail.com">lorenarodriguezr155@gmail.com</a> | Teléfono: <a href="tel:+573222823687">3222823687</a></div>
        &copy; 2025 La Cosmetiquera de Gabi
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Estado global de la aplicación
        let carrito = [];
        let productosPorId = {};
        let productosPorCodigo = {};
        let totalGlobal = 0;

        // Función para formatear moneda
        function formatCurrency(value) {
            return parseFloat(value).toLocaleString('es-CO', {
                style: 'currency',
                currency: 'COP',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            });
        }

        // --- 1. INICIALIZACIÓN ---
        document.addEventListener('DOMContentLoaded', function() {
            // Cargar datos de productos desde Flask
            try {
                const productData = JSON.parse(document.getElementById('product-data').textContent);
                productData.forEach(p => {
                    productosPorId[p.id] = p;
                    productosPorCodigo[p.codigo] = p;
                });
            } catch (e) {
                console.error("Error al cargar datos de productos:", e);
            }

            // Listener para el escaner (al presionar Enter)
            if (document.getElementById('escaner_codigo')) {
                document.getElementById('escaner_codigo').addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        escanearProducto(e.target.value);
                        e.target.value = '';
                    }
                });
            }

            // Listeners para los campos de pago
            document.querySelectorAll('.pago-input').forEach(input => {
                input.addEventListener('input', actualizarPagos);
            });
            
            actualizarPagos();
        });


        // --- 2. LÓGICA DE CARRITO ---
        function escanearProducto(codigo) {
            const producto = productosPorCodigo[codigo];
            if (producto) {
                agregarAlCarrito(producto.id, 1);
            } else {
                alert('Error: Producto no encontrado con ese código.');
            }
        }

        function agregarManual() {
            const productoSelect = document.getElementById('manual_producto');
            const cantidadInput = document.getElementById('manual_cantidad');
            
            if (!productoSelect || !cantidadInput) return;

            const productoId = productoSelect.value;
            const cantidad = parseInt(cantidadInput.value);
            
            if (!productoId) {
                alert('Por favor, seleccione un producto.');
                return;
            }
            if (isNaN(cantidad) || cantidad <= 0) {
                alert('Por favor, ingrese una cantidad válida.');
                return;
            }
            
            agregarAlCarrito(productoId, cantidad);
        }

        function agregarAlCarrito(productoId, cantidad) {
            const producto = productosPorId[productoId];
            if (!producto) return;

            const cantidadAAgregar = parseInt(cantidad);
            const itemEnCarrito = carrito.find(item => item.id == productoId);

            if (itemEnCarrito) {
                const nuevaCantidad = itemEnCarrito.cantidad + cantidadAAgregar;
                if (nuevaCantidad > producto.stock) {
                    alert(`Error: Stock insuficiente para ${producto.nombre}. Disponible: ${producto.stock}`);
                    return;
                }
                itemEnCarrito.cantidad = nuevaCantidad;
            } else {
                if (cantidadAAgregar > producto.stock) {
                    alert(`Error: Stock insuficiente para ${producto.nombre}. Disponible: ${producto.stock}`);
                    return;
                }
                carrito.push({
                    id: producto.id,
                    nombre: producto.nombre,
                    precio: producto.precio,
                    cantidad: cantidadAAgregar,
                    stock: producto.stock
                });
            }
            actualizarCarritoUI();
        }

        function eliminarDelCarrito(productoId) {
            carrito = carrito.filter(item => item.id != productoId);
            actualizarCarritoUI();
        }

        function actualizarCarritoUI() {
            const tbody = document.getElementById('carrito-body');
            if (!tbody) return;

            tbody.innerHTML = '';
            totalGlobal = 0;

            carrito.forEach(item => {
                const subtotal = item.precio * item.cantidad;
                totalGlobal += subtotal;
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.nombre}</td>
                    <td>${item.cantidad}</td>
                    <td>${formatCurrency(subtotal)}</td>
                    <td>
                        <button type="button" class="btn btn-rojo" onclick="eliminarDelCarrito(${item.id})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            const totalFinalSpan = document.getElementById('total-final');
            if(totalFinalSpan) {
                totalFinalSpan.textContent = formatCurrency(totalGlobal).replace('COP', '');
            }
            actualizarPagos(); 
        }

        // --- 3. LÓGICA DE PAGOS ---
        function manejarSeccionPago(monto, seccionId, codigoId, fechaId, esCodigoRequerido = true) {
            const seccion = document.getElementById(seccionId);
            const codigoInput = document.getElementById(codigoId);
            const fechaInput = document.getElementById(fechaId);

            if (!seccion || !codigoInput || !fechaInput) return;

            if (monto > 0) {
                seccion.style.display = 'block';
                fechaInput.setAttribute('required', 'required'); 
                
                if (esCodigoRequerido) {
                    codigoInput.setAttribute('required', 'required');
                } else {
                    codigoInput.removeAttribute('required');
                }
                
                if (!fechaInput.value) {
                    const now = new Date();
                    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                    fechaInput.value = now.toISOString().slice(0, 16);
                }
            } else {
                seccion.style.display = 'none';
                codigoInput.removeAttribute('required');
                fechaInput.removeAttribute('required');
                codigoInput.value = '';
                fechaInput.value = '';
            }
        }

        function actualizarPagos() {
            const pagoEfectivo = parseFloat(document.getElementById('pago_efectivo')?.value) || 0;
            const pagoNequi = parseFloat(document.getElementById('pago_nequi')?.value) || 0;
            const pagoDaviplata = parseFloat(document.getElementById('pago_daviplata')?.value) || 0;
            const pagoTransferencia = parseFloat(document.getElementById('pago_transferencia')?.value) || 0;
            const pagoTarjeta = parseFloat(document.getElementById('pago_tarjeta')?.value) || 0;

            const totalPagado = pagoEfectivo + pagoNequi + pagoDaviplata + pagoTransferencia + pagoTarjeta;
            const montoPendiente = totalGlobal - totalPagado;

            const montoPendienteSpan = document.getElementById('monto-pendiente');
            if (montoPendienteSpan) {
                montoPendienteSpan.textContent = formatCurrency(montoPendiente).replace('COP', '');
            }

            manejarSeccionPago(pagoEfectivo, 'detalles_efectivo', 'codigo_efectivo', 'fecha_efectivo', false); 
            manejarSeccionPago(pagoNequi, 'detalles_nequi', 'codigo_nequi', 'fecha_nequi', true);
            manejarSeccionPago(pagoDaviplata, 'detalles_daviplata', 'codigo_daviplata', 'fecha_daviplata', true);
            manejarSeccionPago(pagoTransferencia, 'detalles_transferencia', 'codigo_transferencia', 'fecha_transferencia', true);
            manejarSeccionPago(pagoTarjeta, 'detalles_tarjeta', 'codigo_tarjeta', 'fecha_tarjeta', true);
        }

        // --- 4. ENVÍO DE FORMULARIO ---
        function validarYEnviar(event) {
            event.preventDefault(); 

            // ¡Importante! Tenemos que pasar el cliente_id al formulario
            const clienteId = document.getElementById('cliente_id').value;
            
            // Creamos un input oculto o lo actualizamos
            let clienteInput = document.getElementById('cliente_id_hidden');
            if (!clienteInput) {
                clienteInput = document.createElement('input');
                clienteInput.type = 'hidden';
                clienteInput.id = 'cliente_id_hidden';
                clienteInput.name = 'cliente_id';
                document.getElementById('form_venta').appendChild(clienteInput);
            }
            clienteInput.value = clienteId;
            

            const pagoEfectivo = parseFloat(document.getElementById('pago_efectivo')?.value) || 0;
            const pagoNequi = parseFloat(document.getElementById('pago_nequi')?.value) || 0;
            const pagoDaviplata = parseFloat(document.getElementById('pago_daviplata')?.value) || 0;
            const pagoTransferencia = parseFloat(document.getElementById('pago_transferencia')?.value) || 0;
            const pagoTarjeta = parseFloat(document.getElementById('pago_tarjeta')?.value) || 0;

            const totalPagado = pagoEfectivo + pagoNequi + pagoDaviplata + pagoTransferencia + pagoTarjeta;

            if (carrito.length === 0) {
                alert('Error: El carrito está vacío.');
                return false;
            }

            if (totalPagado < (totalGlobal - 1)) {
                alert('Error: El total pagado es menor al total de la venta.');
                return false;
            }
            
            const jsonInput = document.getElementById('productos_vendidos_json');
            const totalInput = document.getElementById('total_venta_hidden');
            const form = document.getElementById('form_venta');

            if (jsonInput) jsonInput.value = JSON.stringify(carrito);
            if (totalInput) totalInput.value = totalGlobal;
            
            if (form) {
                if (!form.checkValidity()) {
                    form.reportValidity(); 
                    return false;
                }
                form.submit();
            }
        }
    </script>
</body>
</html>