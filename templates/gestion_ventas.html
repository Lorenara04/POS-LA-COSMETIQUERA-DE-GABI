{% extends "base.html" %}

{% block title %}Gesti√≥n de Ventas{% endblock %}

{% block content %}
<div id="flash-container" class="container mt-3"></div>

<!-- Encabezado Coquette -->
<div class="ventas-header-coquette container mt-4 mb-2">
    <h2 class="mb-1 text-center titulo-ventas-bonita">
        <span class="sparkle">‚ú¶</span>
        <i class="fas fa-chart-line me-2"></i>
        Gesti√≥n de Ventas: Panel de Control
        <span class="sparkle">‚ú¶</span>
    </h2>
    <p class="text-center subtitulo-bonita">
        Resumen de las √∫ltimas <strong>{{ ventas_paginadas.per_page }}</strong> transacciones por p√°gina.
        <br><strong>Acceso Exclusivo para Administradoras.</strong>
    </p>
</div>

<style>
    /* ------------------ PALETA COQUETTE MAGENTA PREMIUM ------------------ */
    :root {
        --color-magenta-principal: #FF2D8D; 
        --color-magenta-suave: #FFE6F1;
        --color-magenta-oscuro: #A80F54;
        --color-fondo-pagina: #FFF7FB;
        --color-tarjeta-fondo: #FFFFFF;
        --color-texto-oscuro: #2f2f2f;
        --color-texto-claro: #7a7a7a;
        --color-borde-suave: #f3c6dc;
        --color-sombra: rgba(168, 15, 84, 0.12);
        --color-anular: #dc3545;

        --coquette-dorado: #f7d7e8;
        --coquette-perla: #fff9fd;
        --coquette-brillo: rgba(255, 45, 141, 0.25);
    }

    body {
        background:
            radial-gradient(1200px circle at 10% -10%, #ffeaf5 0%, transparent 50%),
            radial-gradient(1000px circle at 110% 0%, #ffe0ef 0%, transparent 45%),
            var(--color-fondo-pagina);
        font-family: 'Poppins', sans-serif;
        color: var(--color-texto-oscuro);
    }

    /* Encabezado premium */
    .ventas-header-coquette{
        background: linear-gradient(180deg, #fff, var(--coquette-perla));
        border: 1px solid var(--color-borde-suave);
        border-radius: 18px;
        padding: 18px 12px;
        box-shadow: 0 10px 30px var(--color-sombra);
        position: relative;
        overflow: hidden;
    }
    .ventas-header-coquette::before{
        content:"";
        position:absolute;
        inset:-40%;
        background: radial-gradient(circle, rgba(255,45,141,.10) 0%, transparent 60%);
        transform: rotate(8deg);
        pointer-events:none;
    }

    .sparkle{
        color: var(--color-magenta-principal);
        text-shadow: 0 0 8px var(--coquette-brillo);
        font-weight: 700;
        margin: 0 6px;
    }

    /* T√≠tulos */
    .titulo-ventas-bonita {
        font-weight: 800;
        color: var(--color-magenta-oscuro);
        letter-spacing: 0.7px;
        text-shadow:
            0 2px 0 #fff,
            0 6px 18px var(--coquette-brillo);
    }
    .subtitulo-bonita {
        font-size: 0.95rem;
        color: var(--color-texto-claro);
        margin-bottom: 8px;
        font-weight: 400;
    }

    /* Contenedor principal tipo tarjeta */
    .tabla-container-bonita {
        background-color: var(--color-tarjeta-fondo);
        border: 1px solid var(--color-borde-suave);
        border-radius: 18px;
        padding: 0;
        box-shadow: 0 12px 35px var(--color-sombra);
        margin-top: 26px;
        overflow: hidden;
        position: relative;
    }
    .tabla-container-bonita::after{
        content:"";
        position:absolute;
        height:6px;
        inset:0 0 auto 0;
        background: linear-gradient(90deg, transparent, var(--color-magenta-principal), transparent);
        opacity:.35;
    }

    /* Tabla */
    .tabla-ventas-bonita {
        margin-bottom: 0 !important;
        border-collapse: separate;
    }

    /* Encabezados */
    .tabla-ventas-bonita thead th {
        background: linear-gradient(180deg, var(--color-magenta-suave), #fff);
        color: var(--color-magenta-oscuro);
        border: none;
        text-align: center;
        font-weight: 700;
        padding: 14px 10px;
        font-size: 0.88rem;
        text-transform: uppercase;
        border-bottom: 2px solid var(--color-magenta-principal);
    }
    .tabla-ventas-bonita thead tr th:first-child { border-top-left-radius: 18px; }
    .tabla-ventas-bonita thead tr th:last-child { border-top-right-radius: 18px; }

    /* Filas */
    .tabla-ventas-bonita tbody tr {
        transition: background-color 0.25s ease, transform 0.2s ease, box-shadow .2s ease;
    }
    .tabla-ventas-bonita tbody tr:nth-child(even) {
        background-color: #fffdfd;
    }
    .tabla-ventas-bonita tbody tr:hover {
        background-color: var(--color-magenta-suave);
        transform: translateY(-2px);
        box-shadow: 0 6px 18px rgba(0,0,0,0.08);
    }
    .tabla-ventas-bonita td {
        vertical-align: middle;
        text-align: center;
        color: var(--color-texto-oscuro);
        font-weight: 500;
        padding: 12px 10px;
        font-size: 0.88rem;
    }

    /* Total fuerte */
    .text-magenta-fuerte-bonita {
        color: var(--color-magenta-principal) !important;
        font-weight: 800 !important;
        font-size: 1.08rem;
        text-shadow: 0 0 10px rgba(255,45,141,0.15);
    }

    /* Botones */
    .btn-bonita-detalle, .btn-bonita-anular {
        font-weight: 700;
        border-radius: 999px;
        padding: 8px 18px;
        font-size: 0.83rem;
        transition: all 0.2s ease;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: inline-flex;
        align-items:center;
        gap:6px;
    }

    .btn-bonita-detalle {
        background:
            linear-gradient(135deg, #ff6ab0 0%, var(--color-magenta-principal) 60%, #ff2d8d 100%);
        color: white;
        border: none;
        box-shadow:
            0 6px 16px rgba(255,45,141,0.35),
            inset 0 0 0 2px rgba(255,255,255,0.65);
        position: relative;
        overflow: hidden;
    }
    .btn-bonita-detalle::after{
        content:"";
        position:absolute;
        top:-60%;
        left:-60%;
        width:120%;
        height:120%;
        background: radial-gradient(circle at center, rgba(255,255,255,.6), transparent 55%);
        transform: rotate(15deg);
        opacity:.35;
    }
    .btn-bonita-detalle:hover {
        background:
            linear-gradient(135deg, var(--color-magenta-principal) 0%, var(--color-magenta-oscuro) 80%);
        transform: translateY(-2px);
        box-shadow: 0 10px 22px rgba(168,15,84,0.45);
        color:#fff;
    }

    .btn-bonita-anular {
        background-color: transparent;
        color: var(--color-anular);
        border: 1.6px dashed var(--color-anular);
        padding-left:16px;
        padding-right:16px;
        text-decoration: none;
    }
    .btn-bonita-anular:hover {
        background-color: var(--color-anular);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 6px 14px rgba(220,53,69,0.35);
        border-style: solid;
    }

    /* Paginaci√≥n */
    .pagination .page-item a {
        color: var(--color-magenta-principal);
        border: 1px solid var(--color-magenta-suave);
        border-radius: 999px;
        margin: 0 3px;
        padding: 8px 15px;
        transition: all 0.2s ease;
        font-weight: 600;
        background: #fff;
        box-shadow: 0 2px 6px rgba(255,45,141,0.08);
    }
    .pagination .page-item.active a {
        background-color: var(--color-magenta-principal);
        border-color: var(--color-magenta-principal);
        color: white;
        box-shadow: 0 6px 16px rgba(255,45,141,0.35);
    }
    .pagination .page-item a:hover {
        background-color: var(--color-magenta-suave);
        color: var(--color-magenta-oscuro);
        transform: translateY(-1px);
    }
    .pagination-info-bonita {
        font-size: 0.88rem;
        color: var(--color-texto-claro);
        font-weight: 500;
    }

    /* Modales */
    .modal-content-custom-bonita {
        border-radius: 18px;
        box-shadow: 0 12px 45px rgba(0,0,0,0.18);
        border: 1px solid var(--color-borde-suave);
        overflow:hidden;
    }
    .modal-header-custom-bonita {
        background:
            linear-gradient(135deg, #ff77b7 0%, var(--color-magenta-principal) 60%, #ff2d8d 100%);
        color: white;
        border-radius: 18px 18px 0 0;
        border-bottom: none;
        padding: 18px 20px;
        text-align: center;
        position: relative;
    }
    .modal-header-custom-bonita::after{
        content:"üéÄ";
        position:absolute;
        right:16px;
        top:12px;
        font-size:1.2rem;
        opacity:.9;
        text-shadow:0 2px 8px rgba(0,0,0,.2);
    }
    .modal-header-custom-bonita .modal-title {
        width: 100%;
        font-weight: 700;
        letter-spacing:.4px;
    }
    .btn-close-white-bonita {
        filter: invert(1);
        opacity: 0.9;
    }
    .btn-close-white-bonita:hover { opacity: 1; }

    /* Dentro modal */
    .modal-body h4 {
        color: var(--color-magenta-principal);
        font-weight: 700;
        margin-bottom: 14px;
        border-bottom: 2px dashed var(--color-magenta-suave);
        padding-bottom: 8px;
    }
    .modal-body label {
        font-weight: 600;
        color: var(--color-texto-oscuro);
        margin-bottom: 5px;
    }
    .form-control, .form-select {
        border-radius: 12px;
        border-color: var(--color-borde-suave);
        padding: 10px 14px;
        background:"#fff";
    }
    .form-control:focus, .form-select:focus {
        border-color: var(--color-magenta-principal);
        box-shadow: 0 0 0 0.25rem rgba(255, 45, 141, 0.22);
    }

    #modal-total-venta.fs-4 { font-size: 1.9rem !important; }
    #modal-total-venta {
        color: var(--color-magenta-oscuro) !important;
        font-weight: 800;
        text-shadow: 0 0 10px rgba(255,45,141,0.12);
    }

    /* M√©todos de pago */
    .metodo-pago-editable {
        background-color: #fff;
        border: 1px solid var(--color-borde-suave);
        border-radius: 14px;
        padding: 14px;
        margin-bottom: 12px;
        box-shadow: 0 3px 10px rgba(0,0,0,0.06);
    }
    .metodo-pago-editable label {
        font-weight: 700;
        color: var(--color-magenta-principal);
        display: block;
        margin-bottom: 7px;
    }

    .alert-bonita-custom {
        border-left: 6px solid var(--color-magenta-principal);
        background-color: var(--color-magenta-suave);
        color: var(--color-texto-oscuro);
        border-radius: 12px;
        font-weight: 500;
    }

    /* Select2 */
    .select2-container--bootstrap-5 .select2-selection {
        border-radius: 12px !important;
        border-color: var(--color-borde-suave) !important;
        padding: 0.6rem 1.1rem !important;
    }
    .select2-container--bootstrap-5.select2-container--focus .select2-selection {
        border-color: var(--color-magenta-principal) !important;
        box-shadow: 0 0 0 0.25rem rgba(255, 45, 141, 0.22) !important;
    }
    .select2-container--bootstrap-5 .select2-dropdown {
        border-radius: 12px !important;
        border-color: var(--color-borde-suave) !important;
        box-shadow: 0 8px 22px rgba(0,0,0,0.12);
    }
    .select2-container--bootstrap-5 .select2-results__option--selected {
        background-color: var(--color-magenta-suave) !important;
        color: var(--color-magenta-oscuro) !important;
    }
    .select2-container--bootstrap-5 .select2-results__option--highlighted {
        background-color: var(--color-magenta-principal) !important;
        color: white !important;
    }
</style>

<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

{% if current_user.rol.lower() == 'administrador' %}
<div class="tabla-container-bonita container">
    <div class="table-responsive">
        <table class="table table-striped table-hover text-center tabla-ventas-bonita">
            <thead>
                <tr>
                    <th><i class="fas fa-receipt"></i> N¬∞ Venta</th>
                    <th><i class="fas fa-calendar-alt"></i> Fecha</th>
                    <th><i class="fas fa-money-bill-wave"></i> Total</th>
                    <th><i class="fas fa-user-tag"></i> Vendedor</th>
                    <th><i class="fas fa-user-circle"></i> Cliente</th>
                    <th><i class="fas fa-cog"></i> Gesti√≥n</th>
                </tr>
            </thead>
            <tbody>
                {% for venta in ventas_paginadas.items %}
                <tr>
                    <td>{{ venta.id }}</td>
                    <td data-fecha-iso="{{ venta.fecha }}">{{ venta.fecha | fecha_co }}</td>
                    <td class="text-magenta-fuerte-bonita">${{ venta.total | format_number }}</td>
                    <td>{{ venta.vendedor.username if venta.vendedor else 'N/A' }}</td>
                    <td>{{ venta.comprador.nombre if venta.comprador else 'Contado / Gen√©rico' }}</td>
                    <td>
                        <!-- IMPORTANTE: data-bs-target apunta al modal -->
                        <button type="button" class="btn-bonita-detalle btn me-2"
                            data-bs-toggle="modal"
                            data-bs-target="#detalleModal"
                            data-venta-id="{{ venta.id }}"
                            data-venta-fecha="{{ venta.fecha | fecha_co }}">
                            <i class="fas fa-eye me-1"></i> Detalle
                        </button>
                        <a href="{{ url_for('eliminar_venta', venta_id=venta.id) }}"
                            data-confirm="¬øEst√°s segura de que quieres ANULAR la Venta N¬∞ {{ venta.id }}? Esta acci√≥n es irreversible y devolver√° el stock."
                            class="btn-bonita-anular"><i class="fas fa-undo-alt me-1"></i> Anular</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<nav aria-label="Paginaci√≥n de Ventas">
    <ul class="pagination justify-content-center mt-4">
        <li class="page-item {% if not ventas_paginadas.has_prev %}disabled{% endif %}">
            <a class="page-link" href="{{ url_for('gestion_ventas', page=ventas_paginadas.prev_num) }}" aria-label="Anterior">
                <span aria-hidden="true">&laquo;</span>
            </a>
        </li>

        {% for page_num in ventas_paginadas.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
            {% if page_num %}
                {% if ventas_paginadas.page == page_num %}
                    <li class="page-item active" aria-current="page"><a class="page-link" href="#">{{ page_num }}</a></li>
                {% else %}
                    <li class="page-item"><a class="page-link" href="{{ url_for('gestion_ventas', page=page_num) }}">{{ page_num }}</a></li>
                {% endif %}
            {% else %}
                <li class="page-item disabled"><a class="page-link" href="#">...</a></li>
            {% endif %}
        {% endfor %}

        <li class="page-item {% if not ventas_paginadas.has_next %}disabled{% endif %}">
            <a class="page-link" href="{{ url_for('gestion_ventas', page=ventas_paginadas.next_num) }}" aria-label="Siguiente">
                <span aria-hidden="true">&raquo;</span>
            </a>
        </li>
    </ul>
</nav>
<div class="text-center mt-2">
    <span class="pagination-info-bonita">P√°gina {{ ventas_paginadas.page }} de {{ ventas_paginadas.pages }}. Total de ventas: {{ ventas_paginadas.total }}.</span>
</div>
<hr class="mb-5">

<!-- Modal de Detalle/Edici√≥n -->
<div class="modal fade" id="detalleModal" tabindex="-1" aria-labelledby="detalleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content modal-content-custom-bonita">
            <div class="modal-header modal-header-custom-bonita">
                <h5 class="modal-title" id="detalleModalLabel"><i class="fas fa-file-invoice-dollar me-2"></i> Detalle de Venta N¬∞ <span id="modal-venta-id"></span></h5>
                <button type="button" class="btn-close btn-close-white-bonita" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="form-editar-info-basica" method="POST" action="">
                    <input type="hidden" name="venta_id" id="input-venta-id">

                    <div class="row">
                        <div class="col-md-7">
                            <h4 class="text-secondary"><i class="fas fa-boxes me-2"></i> Art√≠culos Vendidos
                                <button type="button" class="btn btn-sm btn-outline-success ms-3" id="btn-agregar-producto-modal">
                                    <i class="fas fa-plus"></i> A√±adir Art√≠culo
                                </button>
                            </h4>

                            <div class="alert alert-warning mt-2 alert-bonita-custom" role="alert">
                                ‚ö†Ô∏è <strong>Atenci√≥n:</strong> Modificar cantidades recalcula el <strong>Total</strong>. Se valida el stock.
                                <strong>Guarde Cambios al Detalle</strong> antes de actualizar la secci√≥n de pagos.
                            </div>

                            <div class="table-responsive">
                                <table class="table table-striped table-bordered mt-3">
                                    <thead>
                                        <tr>
                                            <th style="width: 40%;">Producto y Detalle</th>
                                            <th style="width: 12%;">Cant.</th>
                                            <th style="width: 18%;">Precio Unit.</th>
                                            <th style="width: 30%;">Subtotal / Anular</th>
                                        </tr>
                                    </thead>
                                    <tbody id="productos-vendidos-body">
                                        <!-- JS -->
                                    </tbody>
                                </table>
                            </div>

                            <div class="text-end mt-3 p-3 border rounded" style="background-color: var(--color-magenta-suave); border-color: var(--color-borde-suave)!important;">
                                <button type="button" class="btn btn-lg btn-bonita-detalle" id="btn-guardar-detalle-venta">
                                    <i class="fas fa-save me-2"></i> Guardar Cambios al Detalle
                                </button>
                                <strong class="ms-3">TOTAL VENTA: </strong> $<span id="modal-total-venta" class="fs-4 text-magenta-fuerte-bonita"></span>
                            </div>
                        </div>

                        <div class="col-md-5 border-start ps-4">
                            <h4 class="text-secondary"><i class="fas fa-info-circle me-2"></i> Informaci√≥n de Transacci√≥n</h4>
                            <div class="mb-3">
                                <label for="modal-fecha" class="text-magenta-fuerte-bonita">Fecha y Hora</label>
                                <input type="text" id="modal-fecha" class="form-control" readonly>
                            </div>
                            <div class="mb-3">
                                <label for="modal-vendedor" class="text-magenta-fuerte-bonita">Vendedor</label>
                                <select name="vendedor_id" id="modal-vendedor" class="form-select" data-bs-theme="bootstrap-5">
                                    {% for user in vendedores_full %}
                                        <option value="{{ user.id }}">{{ user.username }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="modal-cliente" class="text-magenta-fuerte-bonita">Cliente</label>
                                <select name="cliente_id" id="modal-cliente" class="form-select" data-bs-theme="bootstrap-5">
                                    <option value="">Contado / Gen√©rico</option>
                                    {% for cliente in clientes_full %}
                                        <option value="{{ cliente.id }}">{{ cliente.nombre }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <hr>

                            <h4 class="text-secondary"><i class="fas fa-credit-card me-2"></i> Formas de Pago</h4>
                            <div id="modal-detalle-pagos">
                                <div class="metodo-pago-editable">
                                    <label for="input-pago-efectivo">üíµ Efectivo</label>
                                    <input type="number" name="pago_efectivo" id="input-pago-efectivo" class="form-control" step="0.01" min="0" value="0">
                                </div>
                                <div class="metodo-pago-editable">
                                    <label for="input-pago-nequi">üì± Nequi</label>
                                    <input type="number" name="pago_nequi" id="input-pago-nequi" class="form-control" step="0.01" min="0" value="0">
                                </div>
                                <div class="metodo-pago-editable">
                                    <label for="input-pago-daviplata">üü† Daviplata</label>
                                    <input type="number" name="pago_daviplata" id="input-pago-daviplata" class="form-control" step="0.01" min="0" value="0">
                                </div>
                                <div class="metodo-pago-editable">
                                    <label for="input-pago-transferencia">üè¶ Transferencia</label>
                                    <input type="number" name="pago_transferencia" id="input-pago-transferencia" class="form-control" step="0.01" min="0" value="0">
                                </div>
                                <div class="metodo-pago-editable">
                                    <label for="input-pago-tarjeta">üí≥ Tarjeta/Bold</label>
                                    <input type="number" name="pago_tarjeta" id="input-pago-tarjeta" class="form-control" step="0.01" min="0" value="0">
                                </div>
                                <div class="metodo-pago-editable">
                                    <label for="input-codigo-transaccion">üîñ C√≥digo/Referencia</label>
                                    <input type="text" name="codigo_transaccion" id="input-codigo-transaccion" class="form-control" placeholder="Ej: REF123456">
                                </div>
                                <div class="metodo-pago-editable">
                                    <label for="input-fecha-transaccion">üìÖ Fecha Transacci√≥n</label>
                                    <input type="date" name="fecha_transaccion" id="input-fecha-transaccion" class="form-control">
                                </div>
                            </div>

                            <div class="mt-4 text-center">
                                <button type="submit" class="btn btn-lg btn-bonita-detalle">
                                    <i class="fas fa-save me-2"></i> Guardar Info y Pagos
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

    </div>
</div>

<!-- Modal agregar producto -->
<div class="modal fade" id="agregarProductoModal" tabindex="-1" aria-labelledby="agregarProductoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content modal-content-custom-bonita">
            <div class="modal-header modal-header-custom-bonita">
                <h5 class="modal-title" id="agregarProductoModalLabel"><i class="fas fa-plus-circle me-2"></i> A√±adir Art√≠culo a Venta N¬∞ <span id="modal-agregar-venta-id-title"></span></h5>
                <button type="button" class="btn-close btn-close-white-bonita" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="select-producto-agregar" class="form-label">Buscar Producto (por nombre o descripci√≥n)</label>
                    <select id="select-producto-agregar" class="form-select w-100" data-bs-theme="bootstrap-5"></select>
                </div>
                <div id="info-producto-seleccionado" class="mt-3 p-3 border rounded" style="display:none; background-color: var(--color-magenta-suave); border-color: var(--color-borde-suave)!important;">
                    <p><strong>Marca:</strong> <span id="info-marca"></span></p>
                    <p><strong>Precio Venta:</strong> $<span id="info-precio-venta"></span></p>
                    <p><strong>Stock Disponible:</strong> <span id="info-stock"></span> unidades</p>
                    <div class="d-flex align-items-center">
                        <label for="input-cantidad-agregar" class="me-3">Cantidad a A√±adir:</label>
                        <input type="number" id="input-cantidad-agregar" class="form-control w-25 me-3" value="1" min="1">
                        <button type="button" class="btn-bonita-detalle btn" id="btn-confirmar-agregar">
                            <i class="fas fa-cart-plus me-2"></i> A√±adir Art√≠culo
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% else %}
<div class="alert alert-danger text-center">Solo las administradoras pueden acceder a la gesti√≥n de ventas.</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
    let productosEnVenta = [];
    let productosInventario = [];
    let nuevoTotalDetalle = 0;

    function formatCurrency(value) {
        if (typeof value === 'string') value = parseFloat(value);
        if (isNaN(value)) value = 0;
        return value.toLocaleString('es-CO', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
    }

    function flashMessage(message, category = 'success') {
        const container = $('#flash-container');
        if (!container.length) return;
        const bsCategory = category === 'danger' ? 'danger' : (category === 'warning' ? 'warning' : (category === 'info' ? 'info' : 'success'));
        const alertHtml = `<div class="alert alert-${bsCategory} alert-dismissible fade show alert-bonita-custom" role="alert">${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`;
        container.html(alertHtml);
        setTimeout(() => container.empty(), 7000);
    }

    function recalcularTotales() {
        let total = 0;
        productosEnVenta.forEach(p => {
            if (p.cantidad > 0) {
                const subtotal = p.cantidad * p.precio_unitario;
                p.subtotal = subtotal;
                total += subtotal;
            } else {
                p.subtotal = 0;
            }
        });
        nuevoTotalDetalle = total;
        $('#modal-total-venta').text(formatCurrency(total));
    }

    // ‚úÖ FIX: render confiable (siempre muestra algo)
    function renderProductos() {
        const $tbody = $('#productos-vendidos-body');
        $tbody.empty();

        if (!Array.isArray(productosEnVenta)) {
            flashMessage('Error: los productos no llegaron correctamente.', 'danger');
            return;
        }

        const productosVisibles = productosEnVenta.filter(p => p.cantidad > 0);

        if (productosVisibles.length === 0) {
            $tbody.html(`
                <tr>
                    <td colspan="4" class="text-muted text-center">
                        ‚ùó Esta venta no tiene art√≠culos registrados.
                        <br><small>Puedes agregar productos con el bot√≥n ‚ÄúA√±adir Art√≠culo‚Äù.</small>
                    </td>
                </tr>
            `);
            $('#modal-total-venta').text("0");
            return;
        }

        productosVisibles.forEach((p) => {
            const productoInventario = productosInventario.find(inv => inv.id === p.id);
            const stockActual = productoInventario
                ? productoInventario.cantidad_stock + p.cantidad
                : p.cantidad;

            const descripcion_display = p.descripcion || (productoInventario ? productoInventario.descripcion : 'Sin descripci√≥n');
            const marca_display = p.marca || (productoInventario ? productoInventario.marca : 'Sin marca');
            const realIndex = productosEnVenta.indexOf(p);
            const subtotal = p.cantidad * p.precio_unitario;

            const row = `
                <tr data-index="${realIndex}" data-id="${p.id}" data-precio="${p.precio_unitario}">
                    <td class="text-start">
                        <strong>${p.nombre}</strong>
                        <br><small class="text-secondary"><i class="fas fa-tag"></i> ${marca_display}</small>
                        <br><small class="text-muted">${descripcion_display}</small>
                        <br><small class="text-info">(Stock m√°x. editable: ${stockActual})</small>
                    </td>
                    <td>
                        <input type="number" class="form-control form-control-sm text-center input-cantidad-producto"
                                value="${p.cantidad}" min="1" data-index="${realIndex}" style="width: 80px; display: inline-block;">
                    </td>
                    <td>$${formatCurrency(p.precio_unitario)}</td>
                    <td>
                        <span class="fw-bold text-magenta-fuerte-bonita">$${formatCurrency(subtotal)}</span>
                        <button type="button" class="btn btn-sm btn-outline-danger btn-anular-producto ms-2" data-index="${realIndex}" title="Anular este producto y devolver stock">
                            <i class="fas fa-undo-alt"></i>
                        </button>
                    </td>
                </tr>
            `;
            $tbody.append(row);
        });
        recalcularTotales();
    }

    $(document).ready(function() {
        $('#modal-vendedor').select2({ theme: 'bootstrap-5', dropdownParent: $('#detalleModal') });
        $('#modal-cliente').select2({ theme: 'bootstrap-5', dropdownParent: $('#detalleModal') });
    });

    // ‚úÖ Cargar detalle al abrir modal
    $('#detalleModal').on('show.bs.modal', function (event) {
        const button = $(event.relatedTarget);
        const ventaId = button.data('venta-id');
        const ventaFecha = button.data('venta-fecha');
        const modal = $(this);

        modal.find('#modal-venta-id').text(ventaId);
        modal.find('#input-venta-id').val(ventaId);
        $('#modal-agregar-venta-id-title').text(ventaId);
        modal.find('#modal-fecha').val(ventaFecha);
        modal.find('#form-editar-info-basica').attr('action', `/ventas/editar_info/${ventaId}`);
        $('#info-producto-seleccionado').hide();

        $.when(
            $.getJSON(`/api/ventas/detalle/${ventaId}`),
            $.getJSON(`{{ url_for('api_todos_los_productos') }}`)
        ).done(function(ventaResponse, productosResponse) {

            const data = ventaResponse[0];
            productosInventario = productosResponse[0].productos || [];

            if (!data || !data.productos) {
                flashMessage('Error interno al cargar datos.', 'danger');
                modal.modal('hide');
                return;
            }

            productosEnVenta = data.productos.map(p => {
                const inv = productosInventario.find(inv => inv.id === p.id);
                p.nombre = p.nombre || (inv ? inv.nombre : 'Producto Desconocido');
                p.descripcion = p.descripcion || (inv ? inv.descripcion : 'Sin descripci√≥n');
                p.marca = p.marca || (inv ? inv.marca : 'Sin marca');
                p.subtotal = p.cantidad * p.precio_unitario;
                return p;
            });

            renderProductos();

            $('#modal-cliente').val(data.cliente_id || '').trigger('change');
            $('#modal-vendedor').val(data.vendedor_id).trigger('change');

            const pagos = data.pagos || {};
            $('#input-pago-efectivo').val(pagos['Efectivo'] || 0);
            $('#input-pago-nequi').val(pagos['Nequi'] || 0);
            $('#input-pago-daviplata').val(pagos['Daviplata'] || 0);
            $('#input-pago-transferencia').val(pagos['Transferencia'] || 0);
            $('#input-pago-tarjeta').val(pagos['Tarjeta/Bold'] || 0);
            $('#input-codigo-transaccion').val(pagos['Ref_Codigo'] || '');
            $('#input-fecha-transaccion').val(pagos['Ref_Fecha'] || '');

        }).fail(function() {
            flashMessage('Error al cargar los detalles de la venta.', 'danger');
            modal.modal('hide');
        });
    });

    // Modal agregar producto
    $('#agregarProductoModal').on('show.bs.modal', function() {
        const select2Data = productosInventario
            .filter(p => p.cantidad_stock > 0)
            .map(p => ({
                id: p.id,
                text: `${p.nombre} ${p.marca ? '- ' + p.marca : ''} (${p.descripcion ? p.descripcion.substring(0, 30) + (p.descripcion.length > 30 ? '...' : '') : 'Sin descripci√≥n'}) [Stock: ${p.cantidad_stock}]`,
                data: p
            }));

        if ($('#select-producto-agregar').data('select2')) {
            $('#select-producto-agregar').select2('destroy');
        }

        $('#select-producto-agregar').empty().select2({
            theme: 'bootstrap-5',
            dropdownParent: $('#agregarProductoModal'),
            data: select2Data,
            placeholder: "Buscar o seleccionar art√≠culo",
            allowClear: true,
            width: '100%'
        });

        $('#select-producto-agregar').val(null).trigger('change');
        $('#input-cantidad-agregar').val(1);
        $('#info-producto-seleccionado').hide();
    }).on('hidden.bs.modal', function() {
        $('#detalleModal').modal('show');
    });

    $('#select-producto-agregar').on('change', function() {
        const selectedOption = $(this).select2('data')[0];
        if (!selectedOption || !selectedOption.data) {
            $('#info-producto-seleccionado').hide();
            return;
        }
        const producto = selectedOption.data;
        $('#info-marca').text(producto.marca || 'Sin marca');
        $('#info-precio-venta').text(formatCurrency(producto.valor_venta));
        $('#info-stock').text(producto.cantidad_stock);
        $('#info-producto-seleccionado').data('producto', producto).show();
    });

    $('#productos-vendidos-body')
        .on('change', '.input-cantidad-producto', function() {
            const index = $(this).data('index');
            let nuevaCantidad = parseInt($(this).val()) || 0;

            const productoId = productosEnVenta[index].id;
            const itemInSale = productosEnVenta[index];

            const productoInventario = productosInventario.find(inv => inv.id === productoId);
            const stockDisponible = productoInventario ? productoInventario.cantidad_stock + itemInSale.cantidad : Infinity;

            if (nuevaCantidad < 1) {
                flashMessage(`La cantidad m√≠nima es 1.`, 'warning');
                nuevaCantidad = 1;
                $(this).val(1);
            }
            if (nuevaCantidad > stockDisponible) {
                flashMessage(`La cantidad m√°xima disponible (incluyendo la cantidad original) es ${stockDisponible}.`, 'warning');
                nuevaCantidad = stockDisponible;
                $(this).val(stockDisponible);
            }

            productosEnVenta[index].cantidad = nuevaCantidad;
            renderProductos();
        })
        .on('click', '.btn-anular-producto', function() {
            const index = $(this).data('index');
            if (!confirm('¬øAnular este art√≠culo? Se devolver√° el stock al guardar. Continuar?')) return;
            productosEnVenta[index].cantidad = 0;
            renderProductos();
            flashMessage('Art√≠culo marcado para anulaci√≥n. ¬°Guarda los cambios al detalle!', 'warning');
        });

    $('#btn-agregar-producto-modal').on('click', function() {
        $('#modal-agregar-venta-id-title').text($('#modal-venta-id').text());
        $('#agregarProductoModal').modal('show');
        $('#detalleModal').modal('hide');
    });

    $('#btn-confirmar-agregar').on('click', function() {
        const productoData = $('#info-producto-seleccionado').data('producto');
        let cantidad = parseInt($('#input-cantidad-agregar').val());

        if (!productoData || cantidad <= 0 || isNaN(cantidad)) {
            flashMessage('Selecciona un art√≠culo y cantidad v√°lida.', 'danger');
            return;
        }

        const existingItemIndex = productosEnVenta.findIndex(p => p.id === productoData.id);
        const currentInSale = existingItemIndex !== -1 ? productosEnVenta[existingItemIndex].cantidad : 0;
        const stock = productoData.cantidad_stock + currentInSale;

        if (cantidad > stock) {
            flashMessage(`Error: Solo hay ${stock} en stock.`, 'danger');
            return;
        }

        if (existingItemIndex !== -1) {
            productosEnVenta[existingItemIndex].cantidad += cantidad;
        } else {
            productosEnVenta.push({
                id: productoData.id,
                nombre: productoData.nombre,
                descripcion: productoData.descripcion,
                marca: productoData.marca,
                cantidad: cantidad,
                precio_unitario: productoData.valor_venta,
                subtotal: 0
            });
        }

        renderProductos();
        $('#agregarProductoModal').modal('hide');
        flashMessage(`Art√≠culo a√±adido. ¬°Guarda los cambios al detalle!`, 'info');
    });

    $('#btn-guardar-detalle-venta').on('click', function() {
        const ventaId = $('#input-venta-id').val();
        const url = `/api/ventas/detalle/editar/${ventaId}`;

        const productosAEnviar = productosEnVenta.filter(p => p.cantidad > 0).map(p => ({
            id: p.id,
            cantidad: p.cantidad,
            precio_unitario: p.precio_unitario,
        }));

        if (productosAEnviar.length === 0) {
            if (!confirm('La venta quedar√° sin art√≠culos (Total $0). ¬øContinuar?')) return;
        }

        const $btn = $(this);
        $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i> Guardando...');

        $.ajax({
            url: url,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ productos: productosAEnviar }),
            success: function(response) {
                $btn.prop('disabled', false).html('<i class="fas fa-save me-2"></i> Guardar Cambios al Detalle');
                if (response.success) {
                    flashMessage(`‚úÖ Detalle actualizado. Nuevo Total: $${formatCurrency(response.nuevo_total)}. Recargando...`, 'success');

                    nuevoTotalDetalle = response.nuevo_total;
                    $('#modal-total-venta').text(formatCurrency(response.nuevo_total));

                    setTimeout(() => location.reload(), 1500);
                } else {
                    flashMessage(`‚ùå Error: ${response.message}`, 'danger');
                    renderProductos();
                }
            },
            error: function(jqXHR) {
                $btn.prop('disabled', false).html('<i class="fas fa-save me-2"></i> Guardar Cambios al Detalle');
                const errorMsg = jqXHR.responseJSON && jqXHR.responseJSON.message ? jqXHR.responseJSON.message : 'Error de comunicaci√≥n o stock insuficiente.';
                flashMessage(`‚ùå Error: ${errorMsg}`, 'danger');
            }
        });
    });

    // Validaci√≥n de pagos vs total
    $('#form-editar-info-basica').on('submit', function(e) {
        const totalVentaBackend = nuevoTotalDetalle;
        let totalPagos = 0;
        totalPagos += parseFloat($('#input-pago-efectivo').val() || 0);
        totalPagos += parseFloat($('#input-pago-nequi').val() || 0);
        totalPagos += parseFloat($('#input-pago-daviplata').val() || 0);
        totalPagos += parseFloat($('#input-pago-transferencia').val() || 0);
        totalPagos += parseFloat($('#input-pago-tarjeta').val() || 0);

        if (Math.abs(totalVentaBackend - totalPagos) > 0.01) {
            e.preventDefault();
            const diff = totalVentaBackend - totalPagos;
            flashMessage(`‚ùå Error de Descuadre: La suma de pagos ($${formatCurrency(totalPagos)}) no coincide con el Total de Venta ($${formatCurrency(totalVentaBackend)}). Faltan/Sobran: $${formatCurrency(diff)}.`, 'danger');
            return;
        }
    });

    // Confirmaci√≥n de anular venta
    $('.btn-bonita-anular').on('click', function(e) {
        e.preventDefault();
        const confirmMsg = $(this).data('confirm');
        if (confirm(confirmMsg)) {
            window.location.href = $(this).attr('href');
        }
    });
</script>
{% endblock %}
