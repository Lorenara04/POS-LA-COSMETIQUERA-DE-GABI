{% extends "base.html" %}
{% block title %}Gestión de Inventario{% endblock %}
{% block page %}Inventario{% endblock %}

{% block content %}

<style>
  /* =========================
     COQUETTE / ROCOCÓ INVENTARIO
     ========================= */

  /* Iconos más grandes */
  .icon-xl { font-size: 1.4rem !important; }

  /* Card contenedora suave */
  .card-coquette{
    background: #fff;
    border-radius: 18px;
    border: 2px solid #f8c6dd;
    box-shadow: 0 6px 16px rgba(255, 170, 200, 0.25);
  }

  /* Contenedor tabla */
  .table-responsive{
    padding: 8px;
    background: #fff7fb;
    border-radius: 14px;
    border: 2px solid #f8c6dd;
    box-shadow: 0 4px 12px rgba(255, 170, 200, 0.25);
  }

  /* Tabla bonita tipo tarjetas */
  .tabla-inventario{
    width:100%;
    border-collapse: separate !important;
    border-spacing: 0 7px !important;
    font-size: .88rem;
  }

  .tabla-inventario thead th{
    background: linear-gradient(145deg, #000000, #111111) !important;
    color:#fff;
    padding:10px 8px;
    font-weight:700;
    border-radius: 10px;
    text-align:center;
  }

  .tabla-inventario tbody tr{
    background:#fff;
    border-radius:12px;
    box-shadow: 0 3px 8px rgba(255,170,200,.35);
    transition:.2s ease;
  }
  .tabla-inventario tbody tr:nth-child(even){
    background:#fde6f0 !important;
  }
  .tabla-inventario tbody tr:hover{
    background:#f7e0ff !important;
    transform: scale(1.01);
  }

  .tabla-inventario td{
    padding:8px 8px !important;
    vertical-align: middle !important;
    border-right:1px solid rgba(255, 200, 220, 0.45);
  }
  .tabla-inventario td:last-child{ border-right:none; }

  /* Badge stock */
  .badge-stock{
    padding:4px 8px !important;
    font-size:.75rem;
    border-radius:8px;
    box-shadow:0 2px 4px rgba(255,170,200,.4);
  }

  /* Acciones (opción A) */
  .action-container{
    display:flex;
    justify-content:center;
    gap:8px;
    flex-wrap:wrap;
  }
  .btn-action-base{
    width:40px; height:40px;
    border-radius:50%;
    font-size:1.2rem;
    display:flex; align-items:center; justify-content:center;
    border:none;
    transition:.2s ease;
  }
  .btn-action-edit{
    background:#76c2ff !important;
    color:#fff !important;
    box-shadow:0 3px 6px rgba(120,190,255,.5);
  }
  .btn-action-edit:hover{ transform:scale(1.12); background:#42a5f5 !important; }
  .btn-action-delete{
    background:#ff82b2 !important;
    color:#fff !important;
    box-shadow:0 3px 6px rgba(255,150,200,.5);
  }
  .btn-action-delete:hover{ transform:scale(1.12); background:#ec407a !important; }
  .btn-action-barcode{
    background: linear-gradient(135deg, var(--color-principal-light), var(--color-principal)) !important;
    color:#fff !important;
    box-shadow:0 3px 6px rgba(156,2,119,.35);
  }
  .btn-action-barcode:hover{ transform:scale(1.12); filter:brightness(1.05); }

  /* Card recepción rápida */
  .card-recepcion-rapida{
    border-radius:16px;
    border:2px solid #f8c6dd;
    background: linear-gradient(135deg, #fde8f1, #f7e4ff);
    box-shadow: 0 6px 15px rgba(255, 180, 210, 0.35);
  }

  .btn-submit-stock{
    background-color:#e91e63;
    color:#fff;
    border-radius:999px;
    padding:8px 14px;
    font-weight:700;
    border:none;
    transition:.2s ease;
    box-shadow:0 4px 10px rgba(233,30,99,.35);
  }
  .btn-submit-stock:hover{
    background-color:#d81b60;
    transform:translateY(-2px);
  }

  .btn-manual-add{
    background-color:#f48fb1;
    color:#fff;
    border-radius:999px;
    padding:7px 12px;
    font-weight:700;
    border:none;
    box-shadow:0 3px 6px rgba(244,143,177,.4);
    transition:.2s ease;
  }
  .btn-manual-add:hover{ background:#ec407a; transform:translateY(-2px); }

  /* Autocomplete */
  .search-results{
    position:absolute; z-index:20; width:100%;
    max-height:280px; overflow-y:auto;
    background:#fff; border:1px solid #ddd; border-top:none;
    box-shadow:0 6px 14px rgba(0,0,0,.08);
    border-radius:0 0 10px 10px;
  }
  .search-item{ padding:8px 10px; cursor:pointer; }
  .search-item:hover{ background:#f7f7f7; }

  /* ===== Paginación florcitas ===== */
  .pagination-flower{
    display:flex;
    justify-content:center;
    align-items:center;
    gap:10px;
    flex-wrap:wrap;
    margin-top:14px;
  }

  .page-flower{
    width:44px; height:44px;
    display:flex; align-items:center; justify-content:center;
    font-weight:800;
    color:#8a005a;
    text-decoration:none;
    position:relative;
    border:none;
    background:
      radial-gradient(circle at 50% 0%, #ffd6ea 0 45%, transparent 46%),
      radial-gradient(circle at 100% 50%, #ffd6ea 0 45%, transparent 46%),
      radial-gradient(circle at 50% 100%, #ffd6ea 0 45%, transparent 46%),
      radial-gradient(circle at 0% 50%, #ffd6ea 0 45%, transparent 46%),
      radial-gradient(circle at 50% 50%, #ffffff 0 42%, #ffb6e1 43% 100%);
    border-radius:50%;
    box-shadow:0 4px 10px rgba(156,2,119,.25);
    transition:.2s ease;
  }
  .page-flower:hover{
    transform:translateY(-2px) scale(1.06);
    filter:brightness(1.03);
  }
  .page-flower.active{
    color:#fff;
    background:
      radial-gradient(circle at 50% 0%, #ff7fc8 0 45%, transparent 46%),
      radial-gradient(circle at 100% 50%, #ff7fc8 0 45%, transparent 46%),
      radial-gradient(circle at 50% 100%, #ff7fc8 0 45%, transparent 46%),
      radial-gradient(circle at 0% 50%, #ff7fc8 0 45%, transparent 46%),
      radial-gradient(circle at 50% 50%, #9c0277 0 48%, #b60086 49% 100%);
  }

  .page-arrow{
    width:42px; height:42px;
    display:flex; align-items:center; justify-content:center;
    border-radius:999px;
    background:#fff;
    border:2px solid #f8c6dd;
    color:#9c0277;
    text-decoration:none;
    font-size:1.2rem;
    box-shadow:0 3px 8px rgba(255,170,200,.25);
    transition:.2s ease;
  }
  .page-arrow:hover{ transform:translateY(-2px); background:#fff1fa; }

  .page-ellipsis{
    font-weight:800; color:#9c0277;
    padding:0 2px;
  }

  /* Responsive tabla tarjeta */
  @media (max-width: 768px){
    .tabla-inventario thead{ display:none; }
    .tabla-inventario, .tabla-inventario tbody, .tabla-inventario tr, .tabla-inventario td{
      display:block; width:100%;
    }
    .tabla-inventario tr{ margin-bottom:12px; }
    .tabla-inventario td{
      border-right:none !important;
      border-bottom:1px solid rgba(240,220,230,.6);
      padding:10px 12px !important;
    }
    .tabla-inventario td::before{
      content: attr(data-label) ": ";
      font-weight:800;
      display:inline-block;
      width:45%;
      color:#6a1b9a;
    }
  }

  /* ===== Modal Etiqueta Boutique ===== */
  .etiqueta-container {
    width: 360px;
    padding: 20px;
    border-radius: 18px;
    background: #ffffff;
    border: 3px solid var(--color-principal);
    box-shadow: 0 0 15px rgba(0,0,0,0.15);
    text-align: center;
    margin: auto;
  }
  .etiqueta-titulo {
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--color-principal);
    margin-bottom: 6px;
  }
  .etiqueta-precio {
    font-size: 1.4rem;
    font-weight: bold;
    color: var(--color-secundario);
    background: #fff1fa;
    padding: 6px 12px;
    border-radius: 10px;
    margin-top: 6px;
    display: inline-block;
  }
  #barcodeImage { max-width: 260px; margin: 12px 0; }
</style>

<!-- =========================
     MODAL: AGREGAR PRODUCTO
     ========================= -->
<div class="modal fade" id="addProductModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-dark text-white">
        <h5 class="modal-title">Agregar Nuevo Producto</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <form action="{{ url_for('agregar_producto') }}" method="POST">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label fw-bold">Nombre</label>
            <input class="form-control" type="text" name="nombre" required>
          </div>

          <div class="mb-3">
            <label class="form-label fw-bold">Código (Opcional)</label>
            <input class="form-control" type="text" name="codigo">
          </div>

          <div class="mb-3">
            <label class="form-label fw-bold">Descripción</label>
            <input class="form-control" type="text" name="descripcion">
          </div>

          <div class="mb-3">
            <label class="form-label fw-bold">Marca (Opcional)</label>
            <input class="form-control" type="text" name="marca">
          </div>

          <div class="row g-2">
            <div class="col-6">
              <label class="form-label fw-bold">Cantidad</label>
              <input class="form-control" type="number" name="cantidad" min="0" value="0" required>
            </div>
            <div class="col-6">
              <label class="form-label fw-bold">Valor Venta ($)</label>
              <input class="form-control" type="number" name="valor_venta" step="0.01" min="0.01" required>
            </div>
          </div>

          <div class="mt-3">
            <label class="form-label fw-bold">Valor Interno ($)</label>
            <input class="form-control" type="number" name="valor_interno" step="0.01" min="0" value="0">
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar Producto</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- =========================
     MODAL: EDITAR PRODUCTO
     ========================= -->
<div class="modal fade" id="editProductModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-dark text-white">
        <h5 class="modal-title">Editar Producto <span class="badge bg-light text-dark ms-1" id="edit-product-id"></span></h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <form id="editForm" method="POST">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label fw-bold">Nombre</label>
            <input class="form-control" id="edit-nombre" type="text" name="nombre" required>
          </div>

          <div class="mb-3">
            <label class="form-label fw-bold">Código</label>
            <input class="form-control" id="edit-codigo" type="text" name="codigo">
          </div>

          <div class="mb-3">
            <label class="form-label fw-bold">Descripción</label>
            <input class="form-control" id="edit-descripcion" type="text" name="descripcion">
          </div>

          <div class="mb-3">
            <label class="form-label fw-bold">Marca</label>
            <input class="form-control" id="edit-marca" type="text" name="marca">
          </div>

          <div class="row g-2">
            <div class="col-6">
              <label class="form-label fw-bold">Cantidad</label>
              <input class="form-control" id="edit-cantidad" type="number" name="cantidad" min="0" required>
            </div>
            <div class="col-6">
              <label class="form-label fw-bold">Valor Venta ($)</label>
              <input class="form-control" id="edit-valor_venta" type="number" name="valor_venta" step="0.01" min="0.01" required>
            </div>
          </div>

          <div class="mt-3">
            <label class="form-label fw-bold">Valor Interno ($)</label>
            <input class="form-control" id="edit-valor_interno" type="number" name="valor_interno" step="0.01" min="0">
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar Cambios</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- =========================
     MODAL: ETIQUETA / BARCODE
     ========================= -->
<div class="modal fade" id="modalEtiqueta" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header bg-dark text-white">
        <h5 class="modal-title">Etiqueta del Producto</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div class="etiqueta-container" id="etiquetaArea">
          <img src="{{ url_for('static', filename='img/LOGO.png') }}" style="width:80px; margin-bottom:10px;">
          <div class="etiqueta-titulo" id="etq_nombre"></div>
          <div class="text-muted" id="etq_marca"></div>
          <p class="mt-2 mb-1">
            <strong>Código:</strong> <span id="etq_codigo"></span>
          </p>
          <div class="etiqueta-precio">
            $<span id="etq_precio"></span>
          </div>
          <img id="barcodeImage" src="" alt="Código de Barras">
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-info" onclick="imprimirEtiqueta()">Imprimir</button>
        <a id="btnDescargar" download="etiqueta.png" class="btn btn-primary">Descargar PNG</a>
      </div>

    </div>
  </div>
</div>

<!-- =========================
     CONTENIDO PRINCIPAL
     ========================= -->
<div class="container">

  <h1 class="mb-4 text-center">
    <i class="fas fa-boxes-stacked icon-xl me-2"></i>
    Gestión de Inventario
  </h1>

  <!-- ===== Recepción rápida + agregar producto ===== -->
  <div class="card-recepcion-rapida p-3 mb-4 position-relative">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
      <h5 class="mb-0 fw-bold text-dark">Recepción Rápida de Inventario</h5>

      {% if current_user.rol.lower() == 'administrador' %}
      <button class="btn-manual-add" data-bs-toggle="modal" data-bs-target="#addProductModal">
        <i class="fas fa-plus me-1"></i> Agregar Producto
      </button>
      {% endif %}
    </div>

    <form action="{{ url_for('agregar_stock_por_codigo') }}" method="POST" class="row g-2 align-items-end">
      <div class="col-md-6 position-relative">
        <label class="form-label fw-bold">Código de Barras / Buscar Producto</label>
        <input class="form-control input-focus" id="codigo_scanner" name="codigo_scanner"
               placeholder="Escanee o escriba código / nombre / marca" required>
        <div id="search-results-rapid" class="search-results d-none"></div>
      </div>

      <div class="col-md-3">
        <label class="form-label fw-bold">Cantidad</label>
        <input class="form-control input-focus" id="cantidad_scanner" name="cantidad_scanner"
               type="number" min="1" value="1" required>
      </div>

      <div class="col-md-3 d-grid">
        <button class="btn-submit-stock" type="submit">
          <i class="fas fa-boxes-stacked me-1"></i> AGREGAR AL STOCK
        </button>
      </div>
    </form>

    <!-- Detalle rápido -->
    <div id="product-detail-area" class="mt-3 p-3 border rounded bg-white d-none">
      <div class="fw-bold mb-1">Detalle de Producto</div>
      <div class="small text-muted mb-2">Se llena al seleccionar un producto.</div>
      <div class="row g-1 small">
        <div class="col-6"><b>ID:</b> <span id="detail-id"></span></div>
        <div class="col-6"><b>Stock:</b> <span id="detail-cantidad"></span></div>
        <div class="col-12"><b>Nombre:</b> <span id="detail-nombre"></span></div>
        <div class="col-6"><b>Venta:</b> $<span id="detail-venta"></span></div>
        <div class="col-6"><b>Interno:</b> $<span id="detail-interno"></span></div>
      </div>
    </div>
  </div>

  <!-- ===== Buscador global ===== -->
  <form method="GET" class="input-group mb-3">
    <input type="text" class="form-control input-focus"
           name="search" placeholder="Buscar productos por código, nombre o descripción"
           value="{{ search_query }}" id="global_search_input">
    <button class="btn btn-dark" type="submit">
      <i class="fas fa-search icon-xl"></i>
    </button>
  </form>

  <!-- ===== Tabla inventario ===== -->
  <div class="table-responsive">
    <table class="tabla-inventario">
      <thead>
        <tr>
          <th style="width:70px;">ID</th>
          <th style="width:150px;">Código</th>
          <th style="width:140px;">Marca</th>
          <th>Descripción</th>
          <th style="width:120px;">Existencias</th>
          <th style="width:140px;">Costo Interno</th>
          <th style="width:140px;">Venta</th>
          <th style="width:180px;">Acciones</th>
        </tr>
      </thead>

      <tbody>
        {% for p in productos_paginados.items %}
        <tr>
          <td data-label="ID" class="text-center fw-bold">{{ p.id }}</td>
          <td data-label="Código" class="text-center">{{ p.codigo or 'N/A' }}</td>
          <td data-label="Marca" class="text-center">{{ p.marca or 'N/A' }}</td>

          <td data-label="Descripción">
            <div class="fw-bold">{{ p.nombre }}</div>
            <div class="text-muted small">{{ p.descripcion or "Sin descripción" }}</div>
          </td>

          <td data-label="Existencias" class="text-center">
            {% if p.cantidad <= p.stock_minimo %}
              <span class="badge bg-danger badge-stock">{{ p.cantidad|format_number }}</span>
            {% else %}
              <span class="badge bg-success badge-stock">{{ p.cantidad|format_number }}</span>
            {% endif %}
          </td>

          <td data-label="Costo Interno" class="text-center">
            ${{ p.valor_interno|format_number }}
          </td>
          <td data-label="Venta" class="text-center fw-bold">
            ${{ p.valor_venta|format_number }}
          </td>

          <td data-label="Acciones">
            <div class="action-container">
              <!-- EDITAR -->
              <button type="button"
                      class="btn-action-base btn-action-edit"
                      title="Editar"
                      onclick="openEditModal(
                        '{{ p.id }}',
                        '{{ p.nombre|e }}',
                        '{{ p.codigo|e }}',
                        '{{ p.descripcion|e }}',
                        '{{ p.marca|e }}',
                        '{{ p.cantidad }}',
                        '{{ p.valor_venta }}',
                        '{{ p.valor_interno }}'
                      )">
                <i class="fas fa-pen"></i>
              </button>

              <!-- ELIMINAR -->
              <a class="btn-action-base btn-action-delete"
                 title="Eliminar"
                 href="{{ url_for('eliminar_producto', producto_id=p.id) }}"
                 data-confirm="¿Eliminar {{ p.nombre }}? Esto no se puede deshacer.">
                <i class="fas fa-trash"></i>
              </a>

              <!-- ETIQUETA -->
              <button type="button"
                      class="btn-action-base btn-action-barcode"
                      title="Etiqueta"
                      onclick="generarEtiqueta('{{ p.id }}')">
                <i class="fas fa-barcode"></i>
              </button>
            </div>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="8" class="text-center text-muted py-4">
            {% if search_query %}
              No se encontraron productos que coincidan con "{{ search_query }}".
            {% else %}
              No hay productos en el inventario.
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- ===== Paginación Flor ===== -->
  {% if productos_paginados.pages > 1 %}
  <div class="pagination-flower">

    {% if productos_paginados.has_prev %}
      <a class="page-arrow"
         href="{{ url_for('inventario', page=productos_paginados.prev_num, search=search_query) }}"
         aria-label="Anterior">‹</a>
    {% endif %}

    {% for page_num in productos_paginados.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
      {% if page_num %}
        {% if page_num == productos_paginados.page %}
          <span class="page-flower active">{{ page_num }}</span>
        {% else %}
          <a class="page-flower"
             href="{{ url_for('inventario', page=page_num, search=search_query) }}">{{ page_num }}</a>
        {% endif %}
      {% else %}
        <span class="page-ellipsis">…</span>
      {% endif %}
    {% endfor %}

    {% if productos_paginados.has_next %}
      <a class="page-arrow"
         href="{{ url_for('inventario', page=productos_paginados.next_num, search=search_query) }}"
         aria-label="Siguiente">›</a>
    {% endif %}

  </div>
  {% endif %}

</div>

<script>
  /* =========================
     EDIT MODAL (FUNCIONA)
     ========================= */
  function openEditModal(id, nombre, codigo, descripcion, marca, cantidad, valor_venta, valor_interno){
    document.getElementById('edit-product-id').textContent = id;
    document.getElementById('edit-nombre').value = nombre || '';
    document.getElementById('edit-codigo').value = (codigo === 'N/A' ? '' : (codigo || ''));
    document.getElementById('edit-descripcion').value = (descripcion === 'Sin descripción' ? '' : (descripcion || ''));
    document.getElementById('edit-marca').value = (marca === 'N/A' ? '' : (marca || ''));
    document.getElementById('edit-cantidad').value = parseInt(cantidad || 0);
    document.getElementById('edit-valor_venta').value = parseFloat(valor_venta || 0).toFixed(2);
    document.getElementById('edit-valor_interno').value = parseFloat(valor_interno || 0).toFixed(2);

    document.getElementById('editForm').action = `/inventario/editar/${id}`;

    const modal = new bootstrap.Modal(document.getElementById('editProductModal'));
    modal.show();
  }

  /* =========================
     ETIQUETA / BARCODE
     ========================= */
  function generarEtiqueta(id) {
    fetch(`/barcode/${id}`)
      .then(res => res.json())
      .then(data => {
        document.getElementById("etq_nombre").textContent = data.nombre || '';
        document.getElementById("etq_marca").textContent = data.marca || "Sin marca";
        document.getElementById("etq_codigo").textContent = data.codigo || data.id;
        document.getElementById("etq_precio").textContent = data.precio || '';

        document.getElementById("barcodeImage").src = "data:image/png;base64," + data.barcode;
        document.getElementById("btnDescargar").href = "data:image/png;base64," + data.barcode;

        let modal = new bootstrap.Modal(document.getElementById('modalEtiqueta'));
        modal.show();
      })
      .catch(() => alert("No se pudo generar la etiqueta. Revisa la ruta /barcode/<id>."));
  }

  function imprimirEtiqueta() {
    let contenido = document.getElementById("etiquetaArea").innerHTML;
    let ventana = window.open("", "PRINT", "height=600,width=400");

    ventana.document.write(`
      <html><head>
        <title>Imprimir Etiqueta</title>
        <style>
          body { text-align:center; font-family:Arial; }
          img { max-width:250px; }
        </style>
      </head>
      <body>${contenido}</body></html>
    `);

    ventana.document.close();
    ventana.focus();
    ventana.print();
    ventana.close();
  }

  /* =========================
     BUSQUEDA RÁPIDA (SCANNER)
     usa /api/productos/todos
     ========================= */
  document.addEventListener('DOMContentLoaded', () => {
    const inputScanner = document.getElementById('codigo_scanner');
    const resultsDiv = document.getElementById('search-results-rapid');
    const detailArea = document.getElementById('product-detail-area');
    let allProducts = [];

    const fetchProducts = async () => {
      try {
        const response = await fetch('/api/productos/todos');
        const data = await response.json();
        if (data.productos) allProducts = data.productos;
      } catch (error) {
        console.error('Error al cargar productos:', error);
      }
    };
    fetchProducts();

    const renderResults = (matches) => {
      resultsDiv.innerHTML = '';
      if (matches.length > 0 && inputScanner.value.length > 0) {
        matches.forEach(p => {
          const item = document.createElement('div');
          item.className = 'search-item text-gray-700 border-bottom';
          item.innerHTML = `<b>${p.nombre}</b> (${p.marca}) - Stock: ${p.cantidad_stock}`;
          item.onclick = () => selectProduct(p);
          resultsDiv.appendChild(item);
        });
        resultsDiv.classList.remove('d-none');
      } else {
        resultsDiv.classList.add('d-none');
      }
    };

    inputScanner.addEventListener('input', (e) => {
      const query = e.target.value.toLowerCase().trim();
      if (query.length < 2) {
        renderResults([]);
        detailArea.classList.add('d-none');
        return;
      }
      const filtered = allProducts.filter(p =>
        (p.nombre && p.nombre.toLowerCase().includes(query)) ||
        (p.marca && p.marca.toLowerCase().includes(query)) ||
        (p.descripcion && p.descripcion.toLowerCase().includes(query)) ||
        (p.codigo && p.codigo.toLowerCase().includes(query))
      );
      renderResults(filtered.slice(0, 10));
    });

    const selectProduct = (product) => {
      inputScanner.value = product.codigo || product.nombre;
      resultsDiv.classList.add('d-none');

      document.getElementById('detail-id').textContent = product.id;
      document.getElementById('detail-nombre').textContent = product.nombre;
      document.getElementById('detail-cantidad').textContent = product.cantidad_stock;
      document.getElementById('detail-venta').textContent =
        (product.valor_venta || 0).toLocaleString('es-CO');
      document.getElementById('detail-interno').textContent =
        (product.valor_interno || 0).toLocaleString('es-CO');

      detailArea.classList.remove('d-none');
      document.getElementById('cantidad_scanner').focus();
    };

    document.addEventListener('click', (e) => {
      if (!inputScanner.contains(e.target) && !resultsDiv.contains(e.target)) {
        resultsDiv.classList.add('d-none');
      }
    });

    inputScanner.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        document.getElementById('cantidad_scanner').focus();
      }
    });

    document.getElementById('cantidad_scanner').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        this.closest('form').submit();
      }
    });
  });
</script>

{% endblock %}
